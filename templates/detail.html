{% extends "layout.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
    <div class="post-detail" style="position: relative;">
        {% if current_user.is_authenticated and current_user == post.author %}
            <a href="{{ url_for('edit_post', post_id=post.id) }}" style="position: absolute; top: 1.5em; right: 1.5em; font-size: 0.9em;">編集</a>
        {% endif %}
        
       <h1>
    	{{ post.title }}
    	<span id="title-comment-count" style="color: black; font-size: 0.7em; white-space: nowrap;">コメント数({{ post.comments|length }})</span>
	</h1>

        {% if post.image_url %}
        <div class="post-image-container" style="margin-bottom: 15px;">
            <img src="{{ post.image_url }}" alt="投稿画像" class="post-image">
        </div>
        {% endif %}
        
        <div class="post-content" style="max-height: none; overflow-y: visible;">{{ md.convert(linkify_urls(post.content)) | safe }}</div>

        <div class="post-meta">
            <div>
                <small>投稿者: <a href="{{ url_for('user_profile', username=post.author.username) }}" class="{{ post.author.get_username_class() }}">{{ post.author.username }}</a></small> | 
                <small>投稿日時: {{ post.created_at_jst.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                {% if post.updated_at %}
                    <small>/ 最終更新日時: {{ post.updated_at_jst.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                {% endif %}
            </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                {% if current_user.is_authenticated %}
                <form class="bookmark-form" data-post-id="{{ post.id }}" style="margin-bottom: 0;">
                    <button type="button" class="bookmark-toggle-btn" style="background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 0;">
                        <span id="bookmark-icon-{{ post.id }}">
                            {% set is_bookmarked = post.bookmarks.filter_by(user_id=current_user.id).first() %}
                            {% if is_bookmarked %}
                                <img src="{{ url_for('static', filename='icons/bookmarked.png') }}" alt="ブックマーク済み" style="width: 20px; height: 20px;">
                            {% else %}
                                <img src="{{ url_for('static', filename='icons/bookmark.png') }}" alt="ブックマーク" style="width: 20px; height: 20px;">
                            {% endif %}
                        </span>
                    </button>
                </form>
                {% endif %}

                {% if current_user.is_authenticated and (current_user == post.author or current_user.is_admin) %}
                    <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" style="margin-bottom: 0;">
                        <input type="submit" value="削除" onclick="return confirm('本当に削除しますか？');" class="delete-button">
                    </form>
                {% endif %}
            </div>
        </div>
        <hr>

        <div class="comment-container">
            {% if current_user.is_authenticated %}
            <div class="comment-form">
                <h3>コメントする</h3>
                <form method="POST">
                    {{ comment_form.csrf_token }}
                    <div class="form-field">
                    {{ comment_form.content.label }}<br>
                    {{ comment_form.content(rows=5, class="comment-textarea") }}
                    </div>
                 {{ comment_form.submit }}
                </form>
            </div>
            {% else %}
            <div class="comment-form">
                <p>コメントするには<a href="{{ url_for('login') }}">ログイン</a>が必要です。</p>
            </div>
            {% endif %}
        </div>
        <div class="comments">
            <h3 id="comment-count-header">コメント ({{ post.comments|length }})</h3>
            {% for comment in post.comments %}
            <div class="comment-item" id="comment-{{ comment.id }}">
                <div class="comment-header">
                    <a href="{{ url_for('user_profile', username=comment.commenter.username) }}" class="user-icon-link">
                        {% if comment.commenter.icon_url %}
                            <img src="{{ comment.commenter.icon_url }}" alt="{{ comment.commenter.username }}のアイコン" class="user-icon">
                        {% else %}
                            <img src="{{ url_for('static', filename='icons/default_icon.png') }}" alt="デフォルトアイコン" class="user-icon">
                        {% endif %}
                    </a>
                    <div class="comment-meta-and-actions">
                        <div class="comment-meta">
                            <small>コメント投稿者: <a href="{{ url_for('user_profile', username=comment.commenter.username) }}" class="{{ comment.commenter.get_username_class() }}">{{ comment.commenter.username }}</a></small> | 
                            <small>投稿日時: {{ comment.created_at_jst.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                        </div>
                        {% if current_user.is_authenticated and (current_user == comment.commenter or current_user == post.author or current_user.is_admin) %}
                            <div class="comment-actions">
                                <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="POST">
                                    <button type="button" class="delete-button delete-comment-btn" data-comment-id="{{ comment.id }}">削除</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="comment-content">{{ md.convert(comment.content) | safe }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
{% endblock %}