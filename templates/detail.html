{% extends "base_layout.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
    <div class="content-width-limiter">
        <div class="post-detail">
            <h1>
                {{ post.title }}
                <span id="title-comment-count" style="color: black; font-size: 0.7em; white-space: nowrap;">コメント数({{ post.comments|length }})</span>
            </h1>

            {% if post.image_url %}
            <div class="post-image-container" style="margin-bottom: 15px;">
                <img src="{{ post.image_url }}" alt="投稿画像" class="post-image">
            </div>
            {% endif %}
            
            <div class="post-content">{{ post.content | safe_markdown | safe }}</div>

            {% if post.tags %}
                <div class="tag-container">
                    {% for tag in post.tags %}
                        <a href="{{ url_for('search', search_query=tag.name) }}" class="tag-box">{{ tag.name }}</a>
                        {% endfor %}
                </div>
            {% endif %}
            <div class="post-meta">
                <div>
                    <small>投稿者: <a href="{{ url_for('user_profile', username=post.author.username) }}" class="{{ post.author.get_username_class() }}">{{ post.author.username }}</a></small> | 
                    <small>投稿日時: {{ post.created_at_jst.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                    {% if post.updated_at %}
                        <small>/ 最終更新日時: {{ post.updated_at_jst.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                    {% endif %}
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    {% if current_user.is_authenticated %}
                    
                    <form class="like-form" data-post-id="{{ post.id }}" style="margin: 0;">
                        <button type="button" class="like-toggle-btn" style="background: none; border: none; cursor: pointer; font-size: 1.2em; color: #ff4d4f; display: flex; align-items: center; gap: 3px; padding: 0;">
                            <span id="like-icon-{{ post.id }}">
                                {% if post.is_liked %}
                                    <i class="fas fa-heart text-red"></i>
                                {% else %}
                                    <i class="far fa-heart"></i>
                                {% endif %}
                            </span>
                            <span id="like-count-{{ post.id }}" style="font-size: 0.8em; color: #666;">
                                {% if post.likes.count() > 0 %}{{ post.likes.count() }}{% endif %}
                            </span>
                        </button>
                    </form>
                    <form class="bookmark-form" data-post-id="{{ post.id }}" style="margin-bottom: 0;">
                        <button type="button" class="bookmark-toggle-btn" style="background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 0; display: flex; align-items: center;">
                            <span id="bookmark-icon-{{ post.id }}">
                                {% if post.is_bookmarked %}
                                    <img src="{{ url_for('static', filename='icons/bookmarked.png') }}" alt="ブックマーク済み" style="width: 20px; height: 20px;">
                                {% else %}
                                    <img src="{{ url_for('static', filename='icons/bookmark.png') }}" alt="ブックマーク" style="width: 20px; height: 20px;">
                                {% endif %}
                            </span>
                        </button>
                    </form>
                    {% endif %}

                    {% if current_user.is_authenticated and current_user == post.author %}
                        <a href="{{ url_for('edit_post', post_id=post.id) }}" class="delete-button yellow" style="text-decoration: none;">編集</a>
                    {% endif %}
                    {% if current_user.is_authenticated and (current_user == post.author or current_user.is_admin) %}
                        <form method="POST" action="{{ url_for('delete_post', post_id=post.id) }}" style="margin-bottom: 0;">
                            <input type="submit" value="削除" onclick="return confirm('本当に削除しますか？');" class="delete-button">
                        </form>
                    {% endif %}
                </div>
            </div>
            <hr>

            </div> 
        </div> 
        
            <div class="content-width-limiter" style="margin-bottom: 1em;">
                <button id="toggle-comment-form-btn">
                    コメントをする <i class="fas fa-plus"></i>
                </button>
            </div>

            <div class="content-width-limiter">
                <div id="comment-form-container" class="comment-container hidden">
                    {% if current_user.is_authenticated %}
                    <div class="comment-form">
                        <form method="POST">
                            {{ comment_form.csrf_token }}
                            <div class="form-field">
                            {{ comment_form.content.label }}<br>
                            {{ comment_form.content(rows=5, class="comment-textarea") }}
                            </div>
                         {{ comment_form.submit }}
                        </form>
                    </div>
                    {% else %}
                    <div class="comment-form">
                        <p>コメントするには<a href="{{ url_for('login') }}">ログイン</a>が必要です。</p>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="content-width-limiter">
                <h3 id="comment-count-header">コメント ({{ post.comments|length }})</h3>
        
        {# --- マクロ: コメントを再帰的に表示 --- #}
        {% macro render_comment(comment, depth=0) %}
            <div class="comment-item" id="comment-{{ comment.id }}">
                <div class="comment-avatar-column">
                    <a href="{{ url_for('user_profile', username=comment.commenter.username) }}">
                        {% if comment.commenter.icon_url %}
                            <img src="{{ comment.commenter.icon_url }}" alt="icon" class="user-icon">
                        {% else %}
                            <img src="{{ url_for('static', filename='icons/default_icon.png') }}" alt="icon" class="user-icon">
                        {% endif %}
                    </a>
                    {% if comment.replies.count() > 0 %}
                        <div class="thread-line"></div>
                    {% endif %}
                </div>
                
                <div class="comment-main-column">
                    <div class="comment-header">
                        <div class="comment-meta">
                            <strong><a href="{{ url_for('user_profile', username=comment.commenter.username) }}" class="{{ comment.commenter.get_username_class() }}" style="color: #333; text-decoration: none;">{{ comment.commenter.username }}</a></strong>
                            <span style="color: #6c757d; font-size: 0.85em; margin-left: 5px;">{{ comment.created_at_jst.strftime('%Y-%m-%d %H:%M') }}</span>
                        </div>
                        
                        <div class="comment-menu-container">
                            <button class="comment-menu-btn" onclick="toggleCommentMenu('{{ comment.id }}')">︙</button>
                            <div id="comment-menu-{{ comment.id }}" class="comment-menu-dropdown hidden">
                                {% if current_user.is_authenticated %}
                                    <a href="javascript:void(0)" onclick="toggleReplyForm('{{ comment.id }}')">返信する</a>
                                {% endif %}
                                {% if current_user.is_authenticated and (current_user == comment.commenter or current_user == post.author or current_user.is_admin) %}
                                    <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="POST" style="margin:0;">
                                        <button type="submit" class="menu-delete-btn" onclick="return confirm('本当に削除しますか？')">削除</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="comment-content">{{ comment.content | safe_markdown | safe }}</div>
                    <div id="reply-form-{{ comment.id }}" class="reply-form-container hidden">
                        <form method="POST">
                            {{ comment_form.csrf_token }}
                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                            <textarea name="content" rows="2" class="comment-textarea" placeholder="返信を入力..." required style="width: 100%;"></textarea>
                            <div style="text-align: right; margin-top: 5px;">
                                <button type="submit" class="file-upload-btn" style="font-size: 0.85em; padding: 5px 10px;">返信</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            {% if comment.replies %}
                <div class="comment-replies">
                    {% for reply in comment.replies %}
                        {{ render_comment(reply, depth + 1) }}
                    {% endfor %}
                </div>
            {% endif %}
        {% endmacro %}

        {# --- メインループ --- #}
        {% for comment in post.comments %}
            {% if not comment.parent_id %}
                <div class="comment-thread">
                    {{ render_comment(comment) }}
                </div>
            {% endif %}
        {% endfor %}
        
    </div>
{% endblock %}