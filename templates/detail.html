{% extends "base_layout.html" %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
    <div class="content-width-limiter">
        <div class="post-detail">
            <h1>
                {{ post.title | format_review_title(post.tags) | safe }}
                <span id="title-comment-count" style="color: black; font-size: 0.7em; white-space: nowrap;">コメント数({{ post.comments|length }})</span>
            </h1>

            {% if post.image_url %}
            <div class="post-image-container" style="margin-bottom: 15px;">
                <img src="{{ post.image_url }}" alt="投稿画像" class="post-image">
            </div>
            {% endif %}
            
            <div class="post-content">{{ post.content | safe_markdown | safe }}</div>

            {% if post.tags %}
                <div class="tag-container">
                    {% for tag in post.tags %}
                        {% if tag.name == 'review' %}
                            <a href="{{ url_for('review_db') }}" class="tag-box" style="background-color: #ffeb3b; color: #333; border-color: #fbc02d; font-weight:bold;">
                                <img src="{{ url_for('static', filename='icons/dbicon.png') }}" alt="DB" class="review-tag-icon">review
                            </a>
                        {% else %}
                            <a href="{{ url_for('search', search_query=tag.name) }}" class="tag-box">{{ tag.name }}</a>
                        {% endif %}
                    {% endfor %}
                </div>
            {% endif %}
            
            <div class="post-meta" style="display: flex; flex-direction: column; gap: 5px; align-items: flex-start;">
                
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    
                    <a href="{{ url_for('user_profile', username=post.author.username) }}" style="display: flex; align-items: center; text-decoration: none; color: inherit;">
                        {% if post.author.icon_url %}
                            <img src="{{ post.author.icon_url }}" alt="icon" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; margin-right: 5px;">
                        {% else %}
                            <img src="{{ url_for('static', filename='icons/default_icon.png') }}" alt="icon" style="width: 24px; height: 24px; border-radius: 50%; object-fit: cover; margin-right: 5px;">
                        {% endif %}
                        <span class="{{ post.author.get_username_class() }}">{{ post.author.username }}</span>
                    </a>
        
                    {% if current_user.is_authenticated %}
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <form class="like-form" data-post-id="{{ post.id }}" style="margin: 0;">
                            <button type="button" class="like-toggle-btn" style="background: none; border: none; cursor: pointer; font-size: 1.2em; color: #ff4d4f; display: flex; align-items: center; gap: 3px; padding: 0;">
                                <span id="like-icon-{{ post.id }}">
                                    {% if post.is_liked %} <i class="fas fa-heart text-red"></i> {% else %} <i class="far fa-heart"></i> {% endif %}
                                </span>
                                <span id="like-count-{{ post.id }}" style="font-size: 0.8em; color: #666;">
                                {% if post.likes.count() > 0 %}{{ post.likes.count() }}{% endif %}
                                </span>
                            </button>
                        </form>
                        <form class="bookmark-form" data-post-id="{{ post.id }}" style="margin: 0;">
                            <button type="button" class="bookmark-toggle-btn" style="background: none; border: none; cursor: pointer; font-size: 1.2em; padding: 0; display: flex; align-items: center;">
                                <span id="bookmark-icon-{{ post.id }}">
                                    {% if post.is_bookmarked %}
                                        <img src="{{ url_for('static', filename='icons/bookmarked.png') }}" alt="ブックマーク済み" style="width: 20px; height: 20px;">
                                    {% else %}
                                        <img src="{{ url_for('static', filename='icons/bookmark.png') }}" alt="ブックマーク" style="width: 20px; height: 20px;">
                                    {% endif %}
                                </span>
                            </button>
                        </form>
            
                        {% if post.author == current_user or current_user.is_admin %}
                            <a href="{{ url_for('edit_post', post_id=post.id) }}" class="delete-button yellow" style="text-decoration: none; display: inline-block;">編集</a>
                            
                            <form action="{{ url_for('delete_post', post_id=post.id) }}" method="POST" style="margin: 0;">
                                <button type="submit" class="delete-button" onclick="return confirm('本当にこの投稿を削除しますか？');">削除</button>
                            </form>
                        {% endif %}
                    </div> 
                    {% endif %}
                </div>

                <div style="font-size: 0.9em; color: #6c757d;">
                    {{ post.created_at_jst.strftime('%Y-%m-%d %H:%M:%S') }}
                    {% if post.updated_at %}
                        <span style="margin-left: 0.5em;">(更新: {{ post.updated_at_jst.strftime('%Y-%m-%d %H:%M:%S') }})</span>
                    {% endif %}
                </div>

            </div>
        </div> 
    </div> 
        
            <div class="content-width-limiter" style="margin-bottom: 1em;">
                <button id="toggle-comment-form-btn">
                    コメントをする <i class="fas fa-plus"></i>
                </button>
            </div>

            <div class="content-width-limiter">
                <div id="comment-form-container" class="comment-container hidden">
                    {% if current_user.is_authenticated %}
                    <div class="comment-form">
                        <form method="POST">
                            {{ comment_form.csrf_token }}
                            <div class="form-field">
                            {{ comment_form.content.label }}<br>
                            {{ comment_form.content(rows=5, class="comment-textarea") }}
                            </div>
                         {{ comment_form.submit }}
                        </form>
                    </div>
                    {% else %}
                    <div class="comment-form">
                        <p>コメントするには<a href="{{ url_for('login') }}">ログイン</a>が必要です。</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="comments-header content-width-limiter" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em; margin-top: 1.5em;">
                <h3 style="margin: 0;">コメント ({{ post.comments|length }})</h3>

                <div>
                    <select id="comment-sort-select" style="padding: 4px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9em;">
                        <option value="oldest" {% if sort_comments == 'oldest' %}selected{% endif %}>古い順</option>
                        <option value="newest" {% if sort_comments == 'newest' %}selected{% endif %}>新しい順</option>
                    </select>
                </div>
            </div>

            <div class="content-width-limiter">
                {% for comment in post.comments %}
                <div class="comment-item" id="comment-{{ comment.id }}">
                    <div class="comment-header">
                        <div style="display: flex; align-items: center;">
                            <a href="{{ url_for('user_profile', username=comment.commenter.username) }}" class="user-icon-link">
                                {% if comment.commenter.icon_url %}
                                    <img src="{{ comment.commenter.icon_url }}" alt="icon" class="user-icon">
                                {% else %}
                                    <img src="{{ url_for('static', filename='icons/default_icon.png') }}" alt="icon" class="user-icon">
                                {% endif %}
                            </a>
                            <div class="comment-meta">
                                <strong><a href="{{ url_for('user_profile', username=comment.commenter.username) }}" class="{{ comment.commenter.get_username_class() }}" style="color: #333; text-decoration: none;">{{ comment.commenter.username }}</a></strong>
                                <span style="color: #6c757d; font-size: 0.85em; margin-left: 10px;">{{ comment.created_at_jst.strftime('%Y-%m-%d %H:%M') }}</span>
                            </div>
                        </div>

                        {% if current_user.is_authenticated and (current_user == comment.commenter or current_user == post.author or current_user.is_admin) %}
                            <div class="comment-actions">
                                <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="POST" style="margin:0;">
                                    <button type="submit" class="delete-button" onclick="return confirm('本当に削除しますか？')">削除</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="comment-content">{{ comment.content | safe_markdown | safe }}</div>
                </div>
                {% endfor %}
            </div>

            <script>
                // コメント並び替え
                const commentSortSelect = document.getElementById('comment-sort-select');
                if (commentSortSelect) {
                    commentSortSelect.addEventListener('change', function() {
                        const selectedSort = this.value;
                        const currentUrl = new URL(window.location.href);
                        currentUrl.searchParams.set('sort_comments', selectedSort);
                        window.location.href = currentUrl.toString();
                    });
                }
            </script>
            
{% endblock %}