{% extends "base_layout.html" %}

{% block title %}å›è¦§æ¿{% endblock %}

{% block content %}
    
    <div class="content-width-limiter" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">
        
        <div style="display: flex; align-items: baseline; gap: 10px;">
            <h2>å›è¦§æ¿</h2>
            {% if show_all %}
            <a href="{{ url_for('kairanban_index') }}" style="font-size: 0.8em;">(ã‚¿ã‚°çµã‚Šè¾¼ã¿ã«æˆ»ã‚‹)</a>
            {% else %}
                <a href="{{ url_for('kairanban_index', show_all=1) }}" style="font-size: 0.8em;">(ã™ã¹ã¦ã‚’è¡¨ç¤º)</a>
            {% endif %}
        </div>
        
        <div style="display: flex; align-items: center; gap: 15px;">
            <button id="toggle-kairanban-form-btn" style="background: none; border: none; cursor: pointer; padding: 0;">
                <img src="{{ url_for('static', filename='icons/kairanpen.png') }}" alt="æ–°è¦ä½œæˆ" title="æ–°è¦ä½œæˆ" style="width: 32px; height: 32px;">
            </button>
            </div>
    </div>

    <div id="kairanban-form-container" class="hidden content-width-limiter">
    <div class="post-form">
            <h3 style="margin-top:0;">å›è¦§æ¿ã‚’æ–°è¦ä½œæˆ</h3>
            <form method="POST">
                {{ form.csrf_token }}

                <div class="form-field">
                    {{ form.content.label }}<br>
                    {{ form.content(rows=5, class="textarea-content auto-resize-textarea") }}
                    </div>

                <div class="form-field" style="position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">
                        <label for="tags-input-field">{{ form.tags.label }}</label>
                        <a href="javascript:void(0)" id="recent-tags-toggle" title="æœ€è¿‘ä½¿ç”¨ã—ãŸã‚¿ã‚°">
                            <img src="{{ url_for('static', filename='icons/underdir.png') }}" alt="æœ€è¿‘ã®ã‚¿ã‚°" style="width: 20px; height: 20px;">
                        </a>
                    </div>
                    <div id="recent-tags-list" class="recent-tags-dropdown hidden"></div>
                    {{ form.tags(id="tags-input-field", placeholder="ä¾‹: 1ã‚¯ãƒ©ã‚¹, B4, å­¦ç”Ÿèª²") }}
                </div>

                <div class="form-field" style="display: flex; align-items: center; gap: 10px;">
                    <label for="expires_in_days" style="margin: 0; white-space: nowrap;">{{ form.expires_in_days.label }}</label>
                    {{ form.expires_in_days() }}
                </div>
                {{ form.submit }}
            </form>
        </div>
    </div>

    {% if kairanbans %}
        {% for k in kairanbans %}
        <div class="content-width-limiter">
            <div class="post kairanban-item {% if k.id in checked_ids %}checked{% endif %}" id="kairanban-{{ k.id }}">
                
                <div class="post-content" style="max-height: 150px;">{{ k.content | safe_markdown | safe }}</div>
                
                {% if k.tags %}
                    <div class="tag-container">
                        {% for tag in k.tags %}
                            {% set tag_name = tag.name %}
                            {% if tag_name in status_tags.grade %}
                                <a href="{{ url_for('search', search_query=tag_name, active_tab='users') }}" class="tag-box" style="background-color: #007bff; color: white; border-color: #007bff;">{{ tag_name }}</a>
                            {% elif tag_name in status_tags.category or tag_name in status_tags.class %}
                                <a href="{{ url_for('search', search_query=tag_name, active_tab='users') }}" class="tag-box" style="background-color: #6c757d; color: white; border-color: #6c757d;">{{ tag_name }}</a>
                            {% elif tag_name in status_tags.program %}
                                <a href="{{ url_for('search', search_query=tag_name, active_tab='users') }}" class="tag-box" style="background-color: #28a745; color: white; border-color: #28a745;">{{ tag_name }}</a>
                            {% elif tag_name in status_tags.major %}
                                <a href="{{ url_for('search', search_query=tag_name, active_tab='users') }}" class="tag-box" style="background-color: #ffc107; color: black; border-color: #ffc107;">{{ tag_name }}</a>
                            {% else %}
                                <a href="{{ url_for('search', search_query=tag_name) }}" class="tag-box">{{ tag_name }}</a>
                            {% endif %}
                            {% endfor %}
                    </div>
                {% endif %}

                <div class="post-meta">
                    <div>
                        <small>å·®å‡ºäºº: <a href="{{ url_for('user_profile', username=k.author.username) }}" class="{{ k.author.get_username_class() }}">{{ k.author.username }}</a></small> |
                        <small>æ²ç¤ºæœŸé™: <span style="color: #dc3545;">{{ k.expires_at.replace(tzinfo=utc).astimezone(japan_tz).strftime('%Y-%m-%d %H:%M') }} ã¾ã§</span></small>
                    </div>

                    <div class="kairanban-actions" style="display: flex; align-items: center; gap: 10px;">
                        
                        <div class="kairanban-check-container" style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" class="kairanban-check-toggle" data-kairanban-id="{{ k.id }}" id="check-{{ k.id }}"
                                {% if k.id in checked_ids %}checked{% endif %}>
                            <label for="check-{{ k.id }}" style="font-size: 0.9em; color: #555; cursor: pointer;">ç¢ºèªæ¸ˆã¿</label>
                            <span id="check-count-{{ k.id }}" style="font-size: 0.9em; color: #555; margin-left: 5px;">
                            ğŸ‘€ {{ k.check_count }}
                            </span>
                        </div>
                        
                        {% if current_user.is_authenticated and (k.author == current_user or current_user.is_admin) %}
                        <form method="POST" action="{{ url_for('delete_kairanban', kairanban_id=k.id) }}" style="margin-bottom: 0;">
                            <input type="submit" value="æ’¤å›" onclick="return confirm('æœ¬å½“ã«ã“ã®å›è¦§æ¿ã‚’æ’¤å›ã—ã¾ã™ã‹ï¼Ÿ');" class="delete-button" style="font-size: 0.8em; padding: 2px 6px;">
                        </form>
                        {% endif %}

                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="content-width-limiter">
            <div class="post-form">
                <p>è¡¨ç¤ºå¯¾è±¡ã®å›è¦§æ¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            </div>
        </div>
    {% endif %}

{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('toggle-kairanban-form-btn');
    const formContainer = document.getElementById('kairanban-form-container');
    
    if (toggleButton && formContainer) {
        toggleButton.addEventListener('click', function() {
            formContainer.classList.toggle('hidden');
        });
    }
});
</script>
{% endblock %}