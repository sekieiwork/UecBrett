{% extends "base_layout.html" %}

{% block title %}回覧板{% endblock %}

{% block content %}
    
    <div class="content-width-limiter" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">
        
        <div style="display: flex; align-items: baseline; gap: 10px;">
            <h2>回覧板</h2>
            {% if show_all %}
            <a href="{{ url_for('kairanban_index') }}" style="font-size: 0.8em;">(タグ絞り込みに戻る)</a>
            {% else %}
                <a href="{{ url_for('kairanban_index', show_all=1) }}" style="font-size: 0.8em;">(すべてを表示)</a>
            {% endif %}
        </div>
        
        <div style="display: flex; align-items: center; gap: 15px;">
            <button id="toggle-kairanban-form-btn" style="background: none; border: none; cursor: pointer; padding: 0;">
                <img src="{{ url_for('static', filename='icons/kairanpen.png') }}" alt="新規作成" title="新規作成" style="width: 32px; height: 32px;">
            </button>
            </div>
    </div>

    <div id="kairanban-form-container" class="hidden content-width-limiter">
    <div class="post-form">
            <h3 style="margin-top:0;">回覧板を新規作成</h3>
            <form method="POST">
                {{ form.csrf_token }}

                <div class="form-field">
                    {{ form.content.label }}<br>
                    {{ form.content(rows=5, class="textarea-content auto-resize-textarea") }}
                    </div>

                <div class="form-field" style="position: relative;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">
                        <label for="tags-input-field">{{ form.tags.label }}</label>
                        <a href="javascript:void(0)" id="recent-tags-toggle" title="最近使用したタグ">
                            <img src="{{ url_for('static', filename='icons/underdir.png') }}" alt="最近のタグ" style="width: 20px; height: 20px;">
                        </a>
                    </div>
                    <div id="recent-tags-list" class="recent-tags-dropdown hidden"></div>
                    {{ form.tags(id="tags-input-field", placeholder="例: 1クラス, B4, 学生課") }}
                </div>

                <div class="form-field" style="display: flex; align-items: center; gap: 10px;">
                    <label for="expires_in_days" style="margin: 0; white-space: nowrap;">{{ form.expires_in_days.label }}</label>
                    {{ form.expires_in_days() }}
                </div>
                {{ form.submit }}
            </form>
        </div>
    </div>

    {% if kairanbans %}
        {% for k in kairanbans %}
        <div class="content-width-limiter">
            <div class="post kairanban-item {% if k.id in checked_ids %}checked{% endif %}" id="kairanban-{{ k.id }}">
                
                <div class="post-content" style="max-height: 150px;">{{ k.content | safe_markdown | safe }}</div>
                
                {% if k.tags %}
                    <div class="tag-container">
                        {% for tag in k.tags %}
                            <a href="{{ url_for('search', search_query=tag.name) }}" class="tag-box">{{ tag.name }}</a>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="post-meta">
                    <div>
                        <small>差出人: <a href="{{ url_for('user_profile', username=k.author.username) }}" class="{{ k.author.get_username_class() }}">{{ k.author.username }}</a></small> |
                        <small>掲示期限: <span style="color: #dc3545;">{{ k.expires_at.replace(tzinfo=utc).astimezone(japan_tz).strftime('%Y-%m-%d %H:%M') }} まで</span></small>
                    </div>

                    <div class="kairanban-actions" style="display: flex; align-items: center; gap: 10px;">
                        
                        <div class="kairanban-check-container" style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                            <input type="checkbox" class="kairanban-check-toggle" data-kairanban-id="{{ k.id }}" id="check-{{ k.id }}"
                                {% if k.id in checked_ids %}checked{% endif %}>
                            <label for="check-{{ k.id }}" style="font-size: 0.9em; color: #555; cursor: pointer;">確認済み</label>
                        </div>
                        
                        {% if current_user.is_authenticated and (k.author == current_user or current_user.is_admin) %}
                        <form method="POST" action="{{ url_for('delete_kairanban', kairanban_id=k.id) }}" style="margin-bottom: 0;">
                            <input type="submit" value="撤回" onclick="return confirm('本当にこの回覧板を撤回しますか？');" class="delete-button" style="font-size: 0.8em; padding: 2px 6px;">
                        </form>
                        {% endif %}

                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="content-width-limiter">
            <div class="post-form">
                <p>表示対象の回覧板はありません。</p>
            </div>
        </div>
    {% endif %}

{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const toggleButton = document.getElementById('toggle-kairanban-form-btn');
    const formContainer = document.getElementById('kairanban-form-container');
    
    if (toggleButton && formContainer) {
        toggleButton.addEventListener('click', function() {
            formContainer.classList.toggle('hidden');
        });
    }
});
</script>
{% endblock %}