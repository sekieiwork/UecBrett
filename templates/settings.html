{% extends "base_layout.html" %}

{% block title %}設定{% endblock %}

{% block content %}
    <div class="post-form">
        <h2>設定</h2>
        
        <div id="notification-settings-toggle" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 0.5em;">
            <h3 style="margin-top: 0; margin-bottom: 0;">通知の基本設定</h3>
            <span id="toggle-icon" style="font-size: 1.2em;">
                {% if settings_open %}△{% else %}▽{% endif %}
            </span>
        </div>
        
        <div id="notification-settings-content" class="{% if not settings_open %}hidden{% endif %}" style="margin-top: 1.5em;">

            <p style="font-size: 0.9em; color: #555; margin-top: 0;">
                サイト全体でプッシュ通知を受け取るか
            </p>
            <form method="POST">
                {{ form.csrf_token }}
                <div class="form-field" style="display: flex; align-items: center; gap: 10px; margin-bottom: 1.5em; background: none; border: none; box-shadow: none; padding: 0;">
                    {{ form.enable_push(style="width: auto; height: auto;") }}
                    {{ form.enable_push.label(style="margin: 0; font-weight: normal;") }}
                </div>
                
                <p style="font-size: 0.8em; color: #6c757d; margin-top: -1em; margin-bottom: 1.5em;">
                    チェックを外すと、すべてのデバイスでのプッシュ通知が停止
                </p>
                {{ form.submit() }}
            </form>
            
            <hr style="margin: 2em 0;">
            
            <h3>プッシュ通知の管理 (このブラウザ)</h3>

            {% if not current_user.push_notifications_enabled %}
                <p style="font-size: 0.9em; color: #dc3545;">
                    現在「プッシュ通知を有効にする」がオフのため、ブラウザを登録できません。
                </p>
            {% else %}
                <p style="font-size: 0.9em; color: #555; margin-top: 0;">
                    このブラウザでプッシュ通知を受け取るための設定
                </p>
                <button id="push-subscription-btn" class="delete-button yellow" style="margin-right: 15px;" disabled>
                    設定を読み込み中...
                </button>
                <span id="push-status" style="font-size: 0.9em; color: #6c757d;"></span>
            {% endif %}
        
        </div>
    </div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- 設定ページのトグル機能 ---
    const settingsToggle = document.getElementById('notification-settings-toggle');
    const settingsContent = document.getElementById('notification-settings-content');
    const toggleIcon = document.getElementById('toggle-icon');

    if (settingsToggle && settingsContent && toggleIcon) {
        settingsToggle.addEventListener('click', function() {
            const isHidden = settingsContent.classList.toggle('hidden');
            toggleIcon.textContent = isHidden ? '▽' : '△';
        });
    }

    // --- プッシュ通知のJS (マスター設定が無効なら実行しない) ---
    {% if not current_user.push_notifications_enabled %}
        return;
    {% endif %}

    const pushButton = document.getElementById('push-subscription-btn');
    const pushStatus = document.getElementById('push-status');
    let isSubscribed = false;
    let swRegistration = null;

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding)
            .replace(/-/g, '+')
            .replace(/_/g, '/');

        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);

        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    if ('serviceWorker' in navigator && 'PushManager' in window) {
        navigator.serviceWorker.ready.then(function(registration) {
            swRegistration = registration;
            checkSubscriptionStatus();
        }).catch(function(error) {
            console.error('Service Worker の準備に失敗:', error);
            pushStatus.textContent = 'プッシュ通知の準備に失敗しました。';
        });
    } else {
        pushStatus.textContent = 'お使いのブラウザはプッシュ通知に対応していません。';
    }

    function checkSubscriptionStatus() {
        swRegistration.pushManager.getSubscription()
            .then(function(subscription) {
                isSubscribed = !(subscription === null);
                updateButtonUI();
                if (isSubscribed) {
                    pushStatus.textContent = 'このブラウザは通知を受け取れます。';
                } else {
                    pushStatus.textContent = 'このブラウザは現在通知オフです。';
                }
            });
    }

    function updateButtonUI() {
        if (isSubscribed) {
            pushButton.textContent = 'このブラウザの通知を停止する';
            pushButton.classList.remove('yellow');
            pushButton.classList.add('delete-button');
        } else {
            pushButton.textContent = 'このブラウザの通知を許可する';
            pushButton.classList.remove('delete-button');
            pushButton.classList.add('yellow');
        }
        pushButton.disabled = false;
    }

    pushButton.addEventListener('click', function() {
        pushButton.disabled = true;
        if (isSubscribed) {
            unsubscribeUser();
        } else {
            subscribeUser();
        }
    });

    function subscribeUser() {
        fetch('{{ url_for("get_vapid_public_key") }}')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                const applicationServerKey = urlBase64ToUint8Array(data.public_key);
                return swRegistration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: applicationServerKey
                });
            })
            .then(function(subscription) {
                return fetch('{{ url_for("subscribe") }}', {
                    method: 'POST',
                    body: JSON.stringify(subscription),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
            })
            .then(function(response) {
                if (response.ok) {
                    pushStatus.textContent = 'このブラウザで通知を有効にしました！';
                    isSubscribed = true;
                } else {
                    throw new Error('サーバーへの購読登録に失敗しました。');
                }
            })
            .catch(function(err) {
                console.error('購読に失敗しました:', err);
                if (Notification.permission === 'denied') {
                    pushStatus.textContent = 'ブラウザの設定で通知がブロックされています。';
                } else {
                    pushStatus.textContent = '購読処理に失敗しました。';
                }
                isSubscribed = false;
            })
            .finally(function() {
                updateButtonUI();
            });
    }

    function unsubscribeUser() {
        swRegistration.pushManager.getSubscription()
            .then(function(subscription) {
                if (subscription) {
                    fetch('{{ url_for("unsubscribe") }}', {
                        method: 'POST',
                        body: JSON.stringify({ endpoint: subscription.endpoint }),
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });
                    return subscription.unsubscribe();
                }
            })
            .then(function() {
                pushStatus.textContent = 'このブラウザでの通知を停止しました。';
                isSubscribed = false;
            })
            .catch(function(err) {
                console.error('購読解除に失敗しました:', err);
            })
            .finally(function() {
                updateButtonUI();
            });
    }

});
</script>
{% endblock %}