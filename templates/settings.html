{% extends "base_layout.html" %}

{% block title %}設定{% endblock %}

{% block content %}
    <div class="post-form">
        <h2>設定</h2>
        
        <div id="notification-settings-toggle" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5em;">
            <h3 style="margin-top: 0; margin-bottom: 0;">通知の基本設定</h3>
            <span id="toggle-icon" style="font-size: 1.2em;">
                {% if settings_open %}△{% else %}▽{% endif %}
            </span>
        </div>
        
        <div id="notification-settings-content" class="{% if not settings_open %}hidden{% endif %}" style="margin-top: 1.5em;">

            <p style="font-size: 0.9em; color: var(--text-muted); margin-top: 0;">
                サイト全体でプッシュ通知を受け取るか
            </p>
            <form method="POST">
                {{ form.csrf_token }}
                
                <div class="form-field" style="display: flex; align-items: center; gap: 10px; margin-bottom: 1em; background: none; border: none; box-shadow: none; padding: 0;">
                    {{ form.enable_push(style="width: auto; height: auto;", id="master-push-toggle") }}
                    <label for="master-push-toggle" style="margin: 0; font-weight: bold; cursor: pointer;">{{ form.enable_push.label.text }}</label>
                </div>
                
                <div id="detailed-settings" style="margin-left: 20px; margin-bottom: 1.5em; padding-left: 15px; border-left: 3px solid #eee; display: none;">
                    <p style="font-size: 0.9em; color: var(--text-muted); margin-top: 0;">通知を受け取る項目を選択:</p>
                    
                    <div class="form-field" style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5em; background: none; border: none; box-shadow: none; padding: 0;">
                        {{ form.enable_comment_like(style="width: auto; height: auto;") }}
                        {{ form.enable_comment_like.label(style="margin: 0; font-weight: normal; cursor: pointer;") }}
                    </div>
                    
                    <div class="form-field" style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5em; background: none; border: none; box-shadow: none; padding: 0;">
                        {{ form.enable_reply(style="width: auto; height: auto;") }}
                        {{ form.enable_reply.label(style="margin: 0; font-weight: normal; cursor: pointer;") }}
                    </div>
                </div>
                
                <p style="font-size: 0.8em; color: var(--text-muted); margin-top: 0em; margin-bottom: 1.5em;">
                    ※チェックを外すと、すべてのデバイスでのプッシュ通知が停止します
                </p>
                {{ form.submit() }}
            </form>

           
            
            <hr style="margin: 2em 0;">
            
            <h3>プッシュ通知の管理 (このブラウザ)</h3>
            
            <div class="form-field" style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5em; background: none; border: none; box-shadow: none; padding: 0;">
                <input type="checkbox" id="device-push-toggle" style="width: auto; height: auto; cursor: pointer;">
                <label for="device-push-toggle" style="margin: 0; font-weight: normal; cursor: pointer;">
                    このデバイス（ブラウザ）で通知を受け取る
                </label>
            </div>
            
            <p style="font-size: 0.8em; color: var(--text-muted); margin-top: 0;">
                ※「PCはOFF、スマホはON」のように、端末ごとに設定できます。<br>
                ※上記の「サイト全体」の設定が有効になっている必要があります。
            </p>
        </div>
    </div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- 1. 設定ページのトグル開閉機能 (既存) ---
    const settingsToggle = document.getElementById('notification-settings-toggle');
    const settingsContent = document.getElementById('notification-settings-content');
    const toggleIcon = document.getElementById('toggle-icon');

    if (settingsToggle && settingsContent && toggleIcon) {
        settingsToggle.addEventListener('click', function() {
            const isHidden = settingsContent.classList.toggle('hidden');
            toggleIcon.textContent = isHidden ? '▽' : '△';
        });
    }

    // ▼▼▼ 追加: 通知詳細設定の表示切り替え ▼▼▼
    const masterToggle = document.getElementById('master-push-toggle');
    const detailedSettings = document.getElementById('detailed-settings');

    if (masterToggle && detailedSettings) {
        // A. ページを開いたときの初期状態を設定
        if (masterToggle.checked) {
            detailedSettings.style.display = 'block';
        } else {
            detailedSettings.style.display = 'none';
        }

        // B. チェックボックスを切り替えたときの動作
        masterToggle.addEventListener('change', function() {
            if (this.checked) {
                detailedSettings.style.display = 'block'; // ONなら表示
            } else {
                detailedSettings.style.display = 'none';  // OFFなら隠す
            }
        });
    }
    // ▲▲▲ ここまで追加 ▲▲▲


    // --- 2. デバイス別通知設定の制御 (既存) ---
    const deviceToggle = document.getElementById('device-push-toggle');
    const deviceToggleLabel = deviceToggle ? deviceToggle.nextElementSibling : null;

    if (deviceToggle && window.OneSignalDeferred) {
        
        // 最初は操作できないようにして「確認中」であることを示す
        deviceToggle.disabled = true;
        if(deviceToggleLabel) deviceToggleLabel.textContent = "設定を確認しています...";

        window.OneSignalDeferred.push(function(OneSignal) {
            
            // 状態を取得してチェックボックスに反映する関数
            function updateToggleState() {
                const isSubscribed = OneSignal.User.PushSubscription.optedIn;
                const permission = Notification.permission;

                console.log("Check State -> Subscribed:", isSubscribed, " Permission:", permission);

                if (permission === 'denied') {
                    deviceToggle.checked = false;
                    deviceToggle.disabled = true;
                    if(deviceToggleLabel) deviceToggleLabel.textContent = "ブラウザの設定で通知がブロックされています";
                    return;
                }

                // 状態を反映し、操作可能にする
                deviceToggle.checked = isSubscribed;
                deviceToggle.disabled = false;
                if(deviceToggleLabel) deviceToggleLabel.textContent = "このデバイス（ブラウザ）で通知を受け取る";
            }

            // base_layout.html でのログイン処理(100ms〜500ms)が終わるのを待ってから確認する
            setTimeout(function() {
                updateToggleState();
            }, 1000);

            // チェックボックスが変更されたときの処理
            deviceToggle.addEventListener('change', async function() {
                deviceToggle.disabled = true; // 連打防止

                try {
                    if (this.checked) {
                        console.log("User Action: ON");
                        await OneSignal.User.PushSubscription.optIn();
                        // alert("通知を【ON】にしました。");
                    } else {
                        console.log("User Action: OFF");
                        await OneSignal.User.PushSubscription.optOut();
                        // alert("通知を【OFF】にしました。");
                    }
                } catch (e) {
                    console.error("Change setting failed:", e);
                    alert("設定の変更に失敗しました。");
                    deviceToggle.checked = !deviceToggle.checked;
                } finally {
                    deviceToggle.disabled = false;
                    updateToggleState();
                }
            });
            
            OneSignal.User.PushSubscription.addEventListener("change", function(event) {
                updateToggleState();
            });
        });
    }
});
</script>
{% endblock %}