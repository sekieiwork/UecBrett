{% extends "base_layout.html" %}

{% block title %}設定{% endblock %}

{% block content %}
    <div class="post-form">
        <h2>設定</h2>
        
        <div id="notification-settings-toggle" style="cursor: pointer; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5em;">
            <h3 style="margin-top: 0; margin-bottom: 0;">通知の基本設定</h3>
            <span id="toggle-icon" style="font-size: 1.2em;">
                {% if settings_open %}△{% else %}▽{% endif %}
            </span>
        </div>
        
        <div id="notification-settings-content" class="{% if not settings_open %}hidden{% endif %}" style="margin-top: 1.5em;">

            <p style="font-size: 0.9em; color: var(--text-muted); margin-top: 0;">
                サイト全体でプッシュ通知を受け取るか
            </p>
            <form method="POST">
                {{ form.csrf_token }}
                <div class="form-field" style="display: flex; align-items: center; gap: 10px; margin-bottom: 1.5em; background: none; border: none; box-shadow: none; padding: 0;">
                    {{ form.enable_push(style="width: auto; height: auto;") }}
                    {{ form.enable_push.label(style="margin: 0; font-weight: normal;") }}
                </div>
                
                <p style="font-size: 0.8em; color: var(--text-muted); margin-top: -1em; margin-bottom: 1.5em;">
                    チェックを外すと、すべてのデバイスでのプッシュ通知が停止
                </p>
                {{ form.submit() }}
            </form>

           
            
            <hr style="margin: 2em 0;">
            
            <h3>プッシュ通知の管理 (このブラウザ)</h3>

            {% if not current_user.push_notifications_enabled %}
                <p style="font-size: 0.9em; color: #dc3545;">
                    現在「プッシュ通知を有効にする」がオフのため、ブラウザを登録できません。
                </p>
            {% else %}
                <p style="font-size: 0.9em; color: var(--text-muted); margin-top: 0;">
                    このブラウザでプッシュ通知を受け取るための設定
                </p>
                <button id="push-subscription-btn" class="delete-button yellow" style="margin-right: 15px;" disabled>
                    設定を読み込み中...
                </button>
                <span id="push-status" style="font-size: 0.9em; color: var(--text-muted);"></span>
            {% endif %}
        
        </div>
    </div>
{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- 設定ページのトグル機能 ---
    const settingsToggle = document.getElementById('notification-settings-toggle');
    const settingsContent = document.getElementById('notification-settings-content');
    const toggleIcon = document.getElementById('toggle-icon');

    if (settingsToggle && settingsContent && toggleIcon) {
        settingsToggle.addEventListener('click', function() {
            const isHidden = settingsContent.classList.toggle('hidden');
            toggleIcon.textContent = isHidden ? '▽' : '△';
        });
    }

    // --- プッシュ通知のJS (マスター設定が無効なら実行しない) ---
    {% if not current_user.push_notifications_enabled %}
        return;
    {% endif %}

    const pushButton = document.getElementById('push-subscription-btn');
    const pushStatus = document.getElementById('push-status');
    let isSubscribed = false;
    let swRegistration = null;
    let applicationServerPublicKey = null;

    function urlBase64ToUint8Array(base64String) {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        const outputArray = new Uint8Array(rawData.length);
        for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
        }
        return outputArray;
    }

    // 1. 公開鍵を取得
    fetch('{{ url_for("get_vapid_public_key") }}')
        .then(response => response.json())
        .then(data => {
            if (data.public_key) {
                applicationServerPublicKey = urlBase64ToUint8Array(data.public_key);
                // 公開鍵取得後にSWを準備
                if ('serviceWorker' in navigator && 'PushManager' in window) {
                    navigator.serviceWorker.ready.then(function(registration) {
                        swRegistration = registration;
                        checkSubscriptionStatus();
                    });
                } else {
                    pushStatus.textContent = 'このブラウザは対応していません。';
                }
            }
        })
        .catch(err => {
            console.error('公開鍵取得エラー:', err);
            pushStatus.textContent = '通信エラーが発生しました。';
        });

    function checkSubscriptionStatus() {
        swRegistration.pushManager.getSubscription()
            .then(function(subscription) {
                isSubscribed = !(subscription === null);
                updateButtonUI();
                if (isSubscribed) {
                    pushStatus.textContent = 'このブラウザは通知を受け取れます。';
                } else {
                    pushStatus.textContent = '通知は現在オフです。';
                }
            });
    }

    function updateButtonUI() {
        if (isSubscribed) {
            pushButton.textContent = 'このブラウザの通知を停止する';
            pushButton.classList.remove('yellow');
            pushButton.classList.add('delete-button');
        } else {
            pushButton.textContent = 'このブラウザの通知を許可する';
            pushButton.classList.remove('delete-button');
            pushButton.classList.add('yellow');
        }
        if (applicationServerPublicKey) {
            pushButton.disabled = false;
        }
    }

    pushButton.addEventListener('click', function() {
        pushButton.disabled = true; // ボタン連打防止
        if (isSubscribed) {
            unsubscribeUser();
        } else {
            subscribeUser();
        }
    });

    // ▼▼▼ ここが修正の核心（タイムアウト付き購読処理） ▼▼▼
    function subscribeUser() {
        if (!applicationServerPublicKey) {
            pushStatus.textContent = 'エラー: ページをリロードしてください。';
            updateButtonUI();
            return;
        }

        // 1. タイムアウト用Promise (10秒)
        const timeout = new Promise((_, reject) => 
            setTimeout(() => reject(new Error('タイムアウト')), 10000)
        );

        // 2. 実際の購読処理
        const subscribeProcess = swRegistration.pushManager.subscribe({
            userVisibleOnly: true,
            applicationServerKey: applicationServerPublicKey
        })
        .then(function(subscription) {
            // サーバーへ送信
            return fetch('{{ url_for("subscribe") }}', {
                method: 'POST',
                body: JSON.stringify(subscription),
                headers: { 'Content-Type': 'application/json' }
            });
        })
        .then(function(response) {
            if (!response.ok) throw new Error('Server Error');
            return response.json();
        })
        .then(function(data) {
            pushStatus.textContent = '通知購読に成功しました。';
            isSubscribed = true;
        });

        // 3. 競走させる (処理 vs タイムアウト)
        Promise.race([subscribeProcess, timeout])
            .catch(function(err) {
                console.error('購読エラー:', err);
                if (err.message === 'タイムアウト') {
                    pushStatus.textContent = '処理がタイムアウトしました。再試行してください。';
                } else if (Notification.permission === 'denied') {
                    pushStatus.textContent = 'ブラウザ設定で通知がブロックされています。';
                } else {
                    pushStatus.textContent = '購読に失敗しました。';
                }
                isSubscribed = false;
            })
            .finally(function() {
                // ★どんな場合でも必ずボタンを復活させる
                updateButtonUI();
            });
    }
    // ▲▲▲ 修正ここまで ▲▲▲

    function unsubscribeUser() {
        swRegistration.pushManager.getSubscription()
            .then(function(subscription) {
                if (subscription) {
                    // サーバーから削除
                    fetch('{{ url_for("unsubscribe") }}', {
                        method: 'POST',
                        body: JSON.stringify({ endpoint: subscription.endpoint }),
                        headers: { 'Content-Type': 'application/json' }
                    });
                    return subscription.unsubscribe();
                }
            })
            .then(function() {
                pushStatus.textContent = '通知を停止しました。';
                isSubscribed = false;
            })
            .catch(function(err) {
                console.error('解除エラー:', err);
                pushStatus.textContent = '解除に失敗しました。';
            })
            .finally(function() {
                updateButtonUI();
            });
    }

});
</script>
{% endblock %}