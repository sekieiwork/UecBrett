{% extends "base_layout.html" %}

{% block title %}便利機能ハブ{% endblock %}

{% block content %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
    /* 並べ替え可能なカードのスタイル */
    .hub-card {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        padding: 1.5em;
        margin-bottom: 1.5em;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        position: relative;
    }
    
    /* ドラッグ用ハンドル */
    .drag-handle {
        position: absolute;
        top: 15px;
        right: 15px;
        cursor: grab;
        color: #ccc;
        font-size: 1.2em;
        padding: 5px;
    }
    .drag-handle:hover { color: #888; }

    /* ドラッグ中のスタイル */
    .hub-card.sortable-ghost,
    .hub-card.sortable-drag {
        height: auto !important;
        min-height: auto !important;
        overflow: hidden;
        opacity: 0.9;
        background-color: #f0f8ff;
        border: 2px dashed #007bff;
        padding-bottom: 1.5em;
    }
    .hub-card.sortable-ghost > *:not(h3):not(.drag-handle),
    .hub-card.sortable-drag > *:not(h3):not(.drag-handle) {
        display: none !important;
    }
    .hub-card.sortable-drag { cursor: grabbing; }

    /* --- 天気予報のスタイル --- */
    .weather-container {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        color: #333;
        text-align: center;
    }
    .weather-current { margin-bottom: 20px; }
    .weather-temp-big {
        font-size: 5em;
        font-weight: 300;
        line-height: 1;
        letter-spacing: -2px;
        margin: 10px 0;
    }
    .weather-desc {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .weather-meta { font-size: 1em; color: #666; }

    .weather-hourly-wrapper {
        position: relative;
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        border-top: 1px solid #eee;
        border-bottom: 1px solid #eee;
    }

    .hourly-forecast {
        display: flex;
        overflow-x: auto;
        gap: 20px;
        padding: 15px 40px;
        width: 100%;
        scroll-behavior: smooth;
        scrollbar-width: none;
    }
    .hourly-forecast::-webkit-scrollbar { display: none; }
    
    .scroll-arrow {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background-color: rgba(255, 255, 255, 0.8);
        border: 1px solid #ddd;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 5;
        color: #555;
        font-size: 0.9em;
        transition: all 0.2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .left-arrow { left: 5px; }
    .right-arrow { right: 5px; }
    .scroll-arrow:hover {
        transform: translateY(-50%) scale(1.2);
        background-color: #fff;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        color: #007bff;
    }

    .hourly-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        min-width: 50px;
        font-size: 0.9em;
    }
    .hourly-time { color: #666; margin-bottom: 5px; }
    .hourly-icon { font-size: 1.5em; margin: 5px 0; }
    .hourly-pop { color: #007bff; font-size: 0.8em; font-weight: bold; }
    .hourly-temp { font-weight: bold; font-size: 1.1em; }

    /* ▼▼▼ 修正: 週間予報レイアウト ▼▼▼ */
    .daily-forecast { display: flex; flex-direction: column; gap: 10px; }
    .daily-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 5px 0;
        font-size: 1em;
    }
    .daily-day { width: 40px; font-weight: bold; text-align: left; font-size: 0.9em; }
    
    /* アイコンエリア (2つ並び対応) */
    .daily-icon-area { 
        width: 60px;
        text-align: center; 
        font-size: 1.2em; 
        display: flex;
        justify-content: center;
        gap: 3px;
    }
    .daily-icon-area.double-icon { font-size: 0.9em; }

    .daily-pop { width: 35px; color: #007bff; font-size: 0.8em; text-align: right; }
    
    .daily-temp-bar { 
        flex-grow: 1; 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-left: 10px;
        color: #333;
    }
    .temp-low { color: #666; width: 30px; text-align: right;}
    .temp-high { font-weight: bold; width: 30px; text-align: right;}
    /* ▲▲▲ 修正ここまで ▲▲▲ */
    
    /* PDF画像プレビュー */
    #pdf-preview-area {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
        margin-bottom: 15px;
    }
    .pdf-preview-item {
        width: 60px;
        height: 80px;
        object-fit: cover;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .pdf-preview-count {
        font-size: 0.9em;
        color: #666;
        margin-left: 5px;
    }
</style>

<div class="content-width-limiter">
    <h2>便利機能ハブ</h2>
    <p style="font-size: 0.85em; color: #666;">自分が使いたい機能を上に並べ替え可能です！</p>
</div>

<div id="hub-container" class="content-width-limiter">

    <div class="hub-card" data-id="pdf-converter">
        <div class="drag-handle"><i class="fas fa-bars"></i></div>
        <h3 style="margin-top:0; border-bottom: none;">
            <i class="fas fa-file-pdf text-red"></i> 画像をPDFに変換
        </h3>
        <p style="font-size: 0.9em; color: #666;">
            複数の画像をまとめて1つのPDFにします。<br>
        </p>

        <div style="margin-top: 1em;">
            <label for="pdf-images" class="file-upload-btn" style="background-color: #007bff; width: 100%; text-align: center; box-sizing: border-box; display: block; margin-bottom: 10px;">
                <i class="fas fa-images"></i> 画像を選択 (複数可)
            </label>
            <input type="file" id="pdf-images" multiple accept="image/*" style="display: none;">
            
            <div id="pdf-preview-container" style="display: none;">
                <div style="font-size: 0.9em; font-weight: bold;">選択中の画像 <span id="pdf-image-count" class="pdf-preview-count">0枚</span></div>
                <div id="pdf-preview-area"></div>
                <button type="button" id="clear-pdf-images" style="font-size: 0.8em; color: #dc3545; background: none; border: none; cursor: pointer; padding: 0;">
                    <i class="fas fa-trash"></i> 選択をクリア
                </button>
            </div>

            <div style="margin-top: 15px;">
                <label style="font-size: 0.9em; font-weight: bold; display: block; margin-bottom: 5px;">保存するファイル名</label>
                <input type="text" id="pdf-filename" placeholder="例: 数学レポート第1回" 
                       style="width: 100%; padding: 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box;">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button id="download-pdf-btn" class="file-upload-btn" style="background-color: #dc3545; flex: 1; padding: 10px; font-size: 1.1em;" disabled>
                    <i class="fas fa-file-download"></i> 保存
                </button>
                
                <button id="share-pdf-btn" class="file-upload-btn" style="background-color: #007bff; flex: 1; padding: 10px; font-size: 1.1em;" disabled>
                    <i class="fas fa-share-alt"></i> 共有
                </button>
            </div>
            <div id="pdf-status" style="margin-top: 10px; font-size: 0.9em; text-align: center; color: #666;"></div>
        </div>
    </div>

    <div class="hub-card" data-id="weather">
        <div class="drag-handle"><i class="fas fa-bars"></i></div>
        <h3 style="margin-top:0; border-bottom: none;">
            <i class="fas fa-cloud-sun-rain text-blue"></i> 電気通信大学付近の天気
        </h3>
        
        <div id="weather-loading" style="text-align: center; padding: 2em;">
            <i class="fas fa-spinner fa-spin"></i> 読み込み中...
        </div>

        <div id="weather-content" class="weather-container" style="display: none;">
            <div class="weather-current">
                <div class="weather-desc">
                    <span id="current-icon"></span>
                    <span id="current-desc">--</span>
                </div>
                <div class="weather-temp-big">
                    <span id="current-temp">--</span><span style="font-size:0.5em; vertical-align: top;">°</span>
                </div>
                <div class="weather-meta">
                    最高 <span id="today-high">--</span>° ・ 最低 <span id="today-low">--</span>°
                </div>
            </div>

            <div style="text-align: left; font-size: 0.9em; margin-bottom: 5px; color: #666;">
                <i class="far fa-clock"></i> 1時間ごとの予報
            </div>
            
            <div class="weather-hourly-wrapper">
                <button class="scroll-arrow left-arrow" id="scroll-left"><i class="fas fa-chevron-left"></i></button>
                <div class="hourly-forecast" id="hourly-forecast-container"></div>
                <button class="scroll-arrow right-arrow" id="scroll-right"><i class="fas fa-chevron-right"></i></button>
            </div>

            <div style="text-align: left; font-size: 0.9em; margin-bottom: 5px; color: #666;">
                <i class="far fa-calendar-alt"></i> 週間天気予報
            </div>
            <div class="daily-forecast" id="daily-forecast-container"></div>
            
            <p style="font-size: 0.7em; color: #aaa; text-align: right; margin-top: 10px;">
                Data by Open-Meteo.com
            </p>
        </div>
    </div>

    <div class="hub-card" data-id="study">
        <div class="drag-handle"><i class="fas fa-bars"></i></div>
        <h3 style="margin-top:0; border-bottom: none;">
            <i class="fas fa-pen text-green"></i> 活動記録
        </h3>
        <p>日々の学習や活動時間を記録してモチベーションを管理します。</p>
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 15px;">
            <a href="{{ url_for('activity_log_page') }}" class="file-upload-btn" style="background-color: #28a745; text-decoration: none; display: inline-block;">
                活動を記録する
            </a>
            <span style="font-size: 0.8em; color: #999;">※自分だけの非公開ログです</span>
        </div>
    </div>

    <div class="hub-card" data-id="dm">
        <div class="drag-handle"><i class="fas fa-bars"></i></div>
        <h3 style="margin-top:0; border-bottom: none;">
            <i class="fas fa-comments" style="color: #ffc107;"></i> ダイレクトメッセージ
        </h3>
        <p>他のユーザーと個別にメッセージのやり取りができます。</p>
        <div style="text-align: center; padding: 20px; background-color: #f9f9f9; border-radius: 8px; color: #666;">
            <div style="margin-bottom: 10px;">
                <button class="file-upload-btn" style="background-color: #ffc107; opacity: 0.6; cursor: not-allowed;" disabled>
                    個人とやりとりする・見る
                </button>
            </div>
            <i class="fas fa-tools"></i> 現在、別ページにて機能開発中です。
        </div>
    </div>

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // --- 1. 並べ替え機能 ---
    const hubContainer = document.getElementById('hub-container');
    const sortable = new Sortable(hubContainer, {
        animation: 150,
        handle: '.drag-handle',
        forceFallback: true,
        fallbackClass: 'sortable-drag',
        ghostClass: 'sortable-ghost',
        store: {
            get: function (sortable) {
                const order = localStorage.getItem('hubOrder');
                return order ? order.split('|') : [];
            },
            set: function (sortable) {
                const order = sortable.toArray();
                localStorage.setItem('hubOrder', order.join('|'));
            }
        }
    });

    // --- 2. 天気予報 (独自ロジック版) ---
    
    // 天気コード定義
    const WEATHER_CODE_MAP = {
        0: { icon: 'fa-sun', color: '#f39c12', desc: '快晴' },
        1: { icon: 'fa-sun', color: '#f39c12', desc: '晴れ' },
        2: { icon: 'fa-cloud-sun', color: '#95a5a6', desc: '一部曇' },
        3: { icon: 'fa-cloud', color: '#7f8c8d', desc: '曇り' },
        45: { icon: 'fa-smog', color: '#bdc3c7', desc: '霧' },
        48: { icon: 'fa-smog', color: '#bdc3c7', desc: '霧氷' },
        51: { icon: 'fa-cloud-rain', color: '#3498db', desc: '霧雨' },
        53: { icon: 'fa-cloud-rain', color: '#3498db', desc: '霧雨' },
        55: { icon: 'fa-cloud-rain', color: '#3498db', desc: '霧雨' },
        61: { icon: 'fa-umbrella', color: '#3498db', desc: '小雨' },
        63: { icon: 'fa-umbrella', color: '#2980b9', desc: '雨' },
        65: { icon: 'fa-umbrella', color: '#2980b9', desc: '大雨' },
        71: { icon: 'fa-snowflake', color: '#ecf0f1', desc: '小雪' },
        73: { icon: 'fa-snowflake', color: '#ecf0f1', desc: '雪' },
        75: { icon: 'fa-snowflake', color: '#ecf0f1', desc: '大雪' },
        80: { icon: 'fa-cloud-showers-heavy', color: '#2980b9', desc: 'にわか雨' },
        81: { icon: 'fa-cloud-showers-heavy', color: '#2980b9', desc: 'にわか雨' },
        82: { icon: 'fa-cloud-showers-heavy', color: '#2980b9', desc: '激しい雨' },
        95: { icon: 'fa-bolt', color: '#f1c40f', desc: '雷雨' },
        96: { icon: 'fa-bolt', color: '#f1c40f', desc: '雷雨' },
        99: { icon: 'fa-bolt', color: '#f1c40f', desc: '激しい雷雨' }
    };

    // 天気グループ定義 (集計用)
    const WEATHER_GROUPS = {
        'Sunny': { codes: [0, 1], icon: 'fa-sun', color: '#f39c12', priority: 1 },
        'Cloudy': { codes: [2, 3, 45, 48], icon: 'fa-cloud', color: '#7f8c8d', priority: 2 },
        'Rain': { codes: [51, 53, 55, 61, 63, 65, 80, 81, 82], icon: 'fa-umbrella', color: '#3498db', priority: 3 },
        'Snow': { codes: [71, 73, 75, 77, 85, 86], icon: 'fa-snowflake', color: '#ecf0f1', priority: 4 },
        'Thunder': { codes: [95, 96, 99], icon: 'fa-bolt', color: '#f1c40f', priority: 5 }
    };

    function getWeatherIcon(code) {
        return WEATHER_CODE_MAP[code] || { icon: 'fa-question', color: '#ccc', desc: '不明' };
    }

    // コードからグループ名を取得
    function getGroupName(code) {
        for (const [name, group] of Object.entries(WEATHER_GROUPS)) {
            if (group.codes.includes(code)) return name;
        }
        return 'Cloudy'; // デフォルト
    }

    function fetchWeather() {
        const url = 'https://api.open-meteo.com/v1/forecast?latitude=35.650&longitude=139.540&current=temperature_2m,weather_code,apparent_temperature&hourly=temperature_2m,precipitation_probability,weather_code&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max&timezone=Asia%2FTokyo';

        fetch(url)
            .then(res => res.json())
            .then(data => {
                document.getElementById('weather-loading').style.display = 'none';
                document.getElementById('weather-content').style.display = 'block';

                const current = data.current;
                const daily = data.daily;
                const hourly = data.hourly;
                
                // 現在の天気表示
                const weatherInfo = getWeatherIcon(current.weather_code);
                document.getElementById('current-icon').innerHTML = `<i class="fas ${weatherInfo.icon}" style="color: ${weatherInfo.color};"></i>`;
                document.getElementById('current-desc').textContent = weatherInfo.desc;
                document.getElementById('current-temp').textContent = Math.round(current.temperature_2m);
                document.getElementById('today-high').textContent = Math.round(daily.temperature_2m_max[0]);
                document.getElementById('today-low').textContent = Math.round(daily.temperature_2m_min[0]);

                // --- 1時間ごとの予報 ---
                const hourlyContainer = document.getElementById('hourly-forecast-container');
                const now = new Date();
                const jstNow = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Tokyo"}));
                const currentHourStr = jstNow.toISOString().slice(0, 13); // "YYYY-MM-DDTHH"
                
                let startIndex = hourly.time.findIndex(t => t.startsWith(currentHourStr));
                if (startIndex === -1) startIndex = 0;

                let hourlyHTML = '';
                for (let i = startIndex; i < startIndex + 24; i++) {
                    if (!hourly.time[i]) break;
                    
                    const timeStr = hourly.time[i];
                    const dateObj = new Date(timeStr);
                    const h = dateObj.getHours();
                    const code = hourly.weather_code[i];
                    const temp = Math.round(hourly.temperature_2m[i]);
                    const pop = hourly.precipitation_probability[i];
                    const wInfo = getWeatherIcon(code);
                    const label = (i === startIndex) ? '現在' : `${h}:00`;

                    hourlyHTML += `
                        <div class="hourly-item">
                            <div class="hourly-time">${label}</div>
                            <div class="hourly-icon"><i class="fas ${wInfo.icon}" style="color: ${wInfo.color};"></i></div>
                            <div class="hourly-pop">${pop > 0 ? pop + '%' : ''}</div>
                            <div class="hourly-temp">${temp}°</div>
                        </div>
                    `;
                }
                hourlyContainer.innerHTML = hourlyHTML;

                // --- 週間予報 (独自集計ロジック) ---
                const dailyContainer = document.getElementById('daily-forecast-container');
                let dailyHTML = '';
                const weekDays = ['日', '月', '火', '水', '木', '金', '土'];
                const displayDays = Math.min(daily.time.length, 7);

                for (let i = 0; i < displayDays; i++) {
                    const dateStr = daily.time[i]; // "YYYY-MM-DD"
                    const dateObj = new Date(dateStr);
                    const dayName = (i === 0) ? '今日' : weekDays[dateObj.getDay()];
                    
                    // ▼▼▼ ここから独自集計 ▼▼▼
                    // その日の hourly データを集める
                    const dayCodes = [];
                    hourly.time.forEach((t, index) => {
                        if (t.startsWith(dateStr)) {
                            dayCodes.push(hourly.weather_code[index]);
                        }
                    });

                    // グループごとに集計
                    const counts = {};
                    let totalHours = 0;
                    dayCodes.forEach(code => {
                        const group = getGroupName(code);
                        counts[group] = (counts[group] || 0) + 1;
                        totalHours++;
                    });

                    // 多い順にソート
                    const sortedGroups = Object.keys(counts).sort((a, b) => counts[b] - counts[a]);
                    const topGroup = sortedGroups[0];
                    const topCount = counts[topGroup];
                    
                    let iconHTML = '';
                    let iconClass = '';

                    // 【判定】 1位が8割(0.8)以上かどうか
                    if (totalHours > 0 && (topCount / totalHours) >= 0.8) {
                        // 8割以上なら単独表示
                        const info = WEATHER_GROUPS[topGroup];
                        iconHTML = `<i class="fas ${info.icon}" style="color: ${info.color};"></i>`;
                    } else {
                        // それ以下なら、上位2つを表示 (例: 晴れ + くもり)
                        const first = WEATHER_GROUPS[sortedGroups[0]];
                        const second = sortedGroups.length > 1 ? WEATHER_GROUPS[sortedGroups[1]] : first;
                        
                        iconHTML = `<i class="fas ${first.icon}" style="color: ${first.color};"></i>`;
                        if (first !== second) {
                            iconHTML += `<i class="fas ${second.icon}" style="color: ${second.color};"></i>`;
                        }
                        iconClass = 'double-icon'; // CSSでサイズ調整
                    }
                    // ▲▲▲ ここまで ▲▲▲

                    const maxT = Math.round(daily.temperature_2m_max[i]);
                    const minT = Math.round(daily.temperature_2m_min[i]);
                    const pop = daily.precipitation_probability_max[i];

                    dailyHTML += `
                        <div class="daily-row">
                            <div class="daily-day">${dayName}</div>
                            <div class="daily-icon-area ${iconClass}">${iconHTML}</div>
                            <div class="daily-pop">${pop > 0 ? pop + '%' : ''}</div>
                            <div class="daily-temp-bar">
                                <span class="temp-low">${minT}°</span>
                                <div style="flex-grow:1; height:4px; background:#eee; margin:0 10px; border-radius:2px; position:relative;">
                                    <div style="position:absolute; left:0; right:0; top:0; bottom:0; background: linear-gradient(90deg, #a8e063, #56ab2f); opacity:0.3;"></div>
                                </div>
                                <span class="temp-high">${maxT}°</span>
                            </div>
                        </div>
                    `;
                }
                dailyContainer.innerHTML = dailyHTML;

            })
            .catch(err => {
                console.error(err);
                document.getElementById('weather-loading').innerHTML = '<span style="color:red;">天気の取得に失敗しました</span>';
            });
    }

    fetchWeather();

    // 左右スクロールボタン
    const scrollAmount = 200;
    const scrollContainer = document.getElementById('hourly-forecast-container');
    const btnLeft = document.getElementById('scroll-left');
    const btnRight = document.getElementById('scroll-right');

    if (btnLeft && scrollContainer) {
        btnLeft.addEventListener('click', () => {
            scrollContainer.scrollBy({ left: -scrollAmount, behavior: 'smooth' });
        });
    }
    if (btnRight && scrollContainer) {
        btnRight.addEventListener('click', () => {
            scrollContainer.scrollBy({ left: scrollAmount, behavior: 'smooth' });
        });
    }

    // --- 3. PDF変換機能 ---
    const { jsPDF } = window.jspdf;
    const pdfInput = document.getElementById('pdf-images');
    const pdfPreviewArea = document.getElementById('pdf-preview-area');
    const pdfPreviewContainer = document.getElementById('pdf-preview-container');
    const pdfImageCount = document.getElementById('pdf-image-count');
    const clearPdfBtn = document.getElementById('clear-pdf-images');
    const pdfStatus = document.getElementById('pdf-status');
    const pdfFilename = document.getElementById('pdf-filename');
    
    const downloadBtn = document.getElementById('download-pdf-btn');
    const shareBtn = document.getElementById('share-pdf-btn');

    let selectedFiles = [];

    if (pdfInput) {
        pdfInput.addEventListener('change', function(e) {
            if (this.files && this.files.length > 0) {
                selectedFiles = Array.from(this.files);
                updatePdfPreview();
                resetButtons(false);
            }
        });
    }

    if (clearPdfBtn) {
        clearPdfBtn.addEventListener('click', function() {
            selectedFiles = [];
            pdfInput.value = '';
            pdfPreviewContainer.style.display = 'none';
            resetButtons(true);
            pdfStatus.innerText = '';
        });
    }

    function updatePdfPreview() {
        pdfPreviewArea.innerHTML = '';
        pdfImageCount.textContent = `${selectedFiles.length}枚`;
        pdfPreviewContainer.style.display = 'block';

        selectedFiles.forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'pdf-preview-item';
                pdfPreviewArea.appendChild(img);
            };
            reader.readAsDataURL(file);
        });
    }

    function resetButtons(disabled) {
        if (downloadBtn) {
            downloadBtn.disabled = disabled;
            downloadBtn.innerHTML = '<i class="fas fa-file-download"></i> 保存';
            downloadBtn.style.opacity = disabled ? '0.6' : '1';
            downloadBtn.style.cursor = disabled ? 'not-allowed' : 'pointer';
        }
        if (shareBtn) {
            shareBtn.disabled = disabled;
            shareBtn.innerHTML = '<i class="fas fa-share-alt"></i> 共有';
            shareBtn.style.opacity = disabled ? '0.6' : '1';
            shareBtn.style.cursor = disabled ? 'not-allowed' : 'pointer';
        }
    }

    function setProcessingState(btnElement) {
        btnElement.disabled = true;
        btnElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 処理中...';
        pdfStatus.innerText = 'PDFを作成しています...';
    }

    async function generatePDF() {
        const doc = new jsPDF();
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = doc.internal.pageSize.getHeight();
        
        for (let i = 0; i < selectedFiles.length; i++) {
            if (i > 0) doc.addPage();
            
            const file = selectedFiles[i];
            const imgData = await readFileAsDataURL(file);
            
            const imgProps = doc.getImageProperties(imgData);
            
            const ratio = imgProps.width / imgProps.height;
            const pdfRatio = pdfWidth / pdfHeight;
            
            let w, h;
            // 余白なし
            if (ratio > pdfRatio) {
                w = pdfWidth;
                h = w / ratio;
            } else {
                h = pdfHeight;
                w = h * ratio;
            }
            
            const x = (pdfWidth - w) / 2;
            const y = (pdfHeight - h) / 2;

            doc.addImage(imgData, 'JPEG', x, y, w, h);
            pdfStatus.innerText = `${i + 1} / ${selectedFiles.length} 枚目を処理完了`;
        }
        return doc;
    }

    if (downloadBtn) {
        downloadBtn.addEventListener('click', async function() {
            if (selectedFiles.length === 0) return;
            setProcessingState(downloadBtn);

            try {
                const filenameText = pdfFilename.value.trim() || '画像まとめ';
                const filename = filenameText.endsWith('.pdf') ? filenameText : filenameText + '.pdf';
                
                const doc = await generatePDF();
                doc.save(filename);
                
                pdfStatus.innerText = '保存しました！';
            } catch (err) {
                console.error(err);
                pdfStatus.innerText = 'エラーが発生しました';
            } finally {
                resetButtons(false);
            }
        });
    }

    if (shareBtn) {
        shareBtn.addEventListener('click', async function() {
            if (selectedFiles.length === 0) return;
            setProcessingState(shareBtn);

            try {
                const filenameText = pdfFilename.value.trim() || '画像まとめ';
                const filename = filenameText.endsWith('.pdf') ? filenameText : filenameText + '.pdf';
                
                const doc = await generatePDF();
                const blob = doc.output('blob');
                const file = new File([blob], filename, { type: "application/pdf" });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    try {
                        await navigator.share({
                            files: [file],
                            title: filename,
                            text: 'PDFファイルを作成しました'
                        });
                        pdfStatus.innerText = '共有メニューを開きました';
                    } catch (shareErr) {
                        if (shareErr.name !== 'AbortError') {
                            doc.save(filename);
                            pdfStatus.innerText = '共有できなかったため保存しました';
                        } else {
                            pdfStatus.innerText = '共有をキャンセルしました';
                        }
                    }
                } else {
                    doc.save(filename);
                    pdfStatus.innerText = 'この端末は共有未対応のため保存しました';
                }
            } catch (err) {
                console.error(err);
                pdfStatus.innerText = 'エラーが発生しました';
            } finally {
                resetButtons(false);
            }
        });
    }

    function readFileAsDataURL(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

});
</script>
{% endblock %}