<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UEC 掲示板</title>
    {% if templates_for_js %}
    <script>
    const TEMPLATES_DATA = {{ templates_for_js | safe }};
    </script>
    {% endif %}
    <style>
    /*----------------------------------*/
    /* 全体的な設定とリセット */
    /*----------------------------------*/
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        line-height: 1.4;
        color: #333;
        background-color: #f8f9fa;
        padding-top: 70px;
    }

    a { color: #007bff; text-decoration: none; }

    a:hover { text-decoration: underline; }
    .container { max-width: 800px; margin: 2em auto; padding: 1em; }
    .post, .post-form, .post-detail, .comment-container, .comments, .comment-item, .form-field, .user-info {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1.5em;
        margin-bottom: 1.5em;
        max-width: 770px;
        margin-left: auto;
        margin-right: auto;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }


    /* コンテナの幅を制限 */
    .container {
        max-width: 800px;
        margin: 2em auto;
        padding: 1em;
    }

    /* ボックスの共通スタイル */
    .post, .post-form, .post-detail, .comment-container, .comments, .comment-item, .form-field, .user-info {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1.5em;
        margin-bottom: 1.5em;
        max-width: 770px;
        margin-left: auto;
        margin-right: auto;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    /* タイトルとヘッダー */
    .post h3, .post-detail h1 { margin-top: 0; margin-bottom: 0.5em; font-size: 1.5em; }
    .post-form h2 { margin-top: 0; margin-bottom: 0.5em; padding-bottom: 0.5em; border-bottom: 1px solid #dee2e6; }

    /* 1. 全てのテキストエリアの共通設定 */
    textarea {
        width: 100%;
        padding: 0.5em;
        box-sizing: border-box;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        line-height: 1.4;
        resize: none;
    }

    /* ▼▼▼ ① ここから修正 ▼▼▼ */
    /* 意図: form内のテキスト入力欄のスタイルを定義します。
       width: 100% と box-sizing: border-box; で、textareaと横幅が揃うようになります。*/
    form input[type="text"],
form input[type="password"] {
        width: 100%;
        padding: 0.5em;
        box-sizing: border-box;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        font-size: 1em; /* ブラウザごとの差異を吸収 */
        height: auto;
    }
    /* ▲▲▲ ① ここまで修正 ▲▲▲ */


    /* 2. 本文入力・編集用の自動リサイズ設定 */
    .auto-resize-textarea {
        resize: none;
        overflow: hidden;
        max-height: 400px; /* 最大の高さを400pxに設定 */
    }

    /* 3. コメント入力用の設定 (手動リサイズはなし) */
    .comment-textarea {
        min-height: 80px; /* 最低限の高さを確保 */
    }

    /* auto-resize-textareaが最大高さに達した場合、スクロールバーを表示 */
    .auto-resize-textarea:focus {
        overflow-y: auto;
    }


    /* 4. 新規投稿フォーム用の追加スタイル */
    .textarea-content {
        min-height: 100px;
    }
    
    /* 5. 表示される投稿・コメント本文の行間設定 */
    .post-content {
        max-height: 100px;
        overflow-y: auto;
        padding: 1em;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        margin-top: 10px;
        width: 100%;
        box-sizing: border-box;
        white-space: pre-wrap;
        line-height: 0.9;
    }

     .comment-content {
        max-height: 100px;
        overflow-y: auto;
        padding: 1em;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        margin-top: 10px;
        width: 100%;
        box-sizing: border-box;
        white-space: pre-wrap;
        line-height: 0.7;
     }

    /* 投稿された画像のスタイル */
    .post-image {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
        margin-top: 15px;
	display: block;
        margin-left: auto;
        margin-right: auto;
    }

    /* 投稿フッター（投稿者情報、ブックマーク）のスタイル */
    .post-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1em;
        font-size: 0.9em;
        color: #6c757d;
    }
    .post-meta small {
        white-space: nowrap;
    }

    /* ボタンのスタイル */
    input[type="submit"] {
        padding: 0.5em 1em;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        background-color: #007bff;
        color: #fff;
    }
    input[type="submit"]:hover {
        background-color: #0056b3;
    }

    .delete-button {
        font-size: 0.8em;
        padding: 0.2em 0.5em;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
    }
    .delete-button:hover {
        background-color: #c82333;
    }
    .delete-button.yellow {
        background-color: #ffc107;
        color: black;
    }
    .delete-button.yellow:hover {
        background-color: #e0a800;
    }

    /* ページネーション */
    .pagination a {
        padding: 0.5em 0.75em;
        border: 1px solid #dee2e6;
        margin: 0 0.25em;
        border-radius: 0.25rem;
    }
    .pagination a[style="font-weight: bold;"] {
        background-color: #007bff;
        color: #fff;
        border-color: #007bff;
    }

    /*----------------------------------*/
    /* ヘッダーのスタイル */
    /*----------------------------------*/
    .header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: #fff;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 0.5em 0;
    }

    .header-content {
        max-width: 800px;
        margin: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: nowrap;
    }

    .header-left, .header-right {
        display: flex;
        align-items: center;
        flex-wrap: nowrap;
    }

    .header-left h1 {
        margin: 0;
        margin-right: 1em;
    }

    .header-left h1 a {
        text-decoration: none;
        color: inherit;
        white-space: nowrap;
    }

    .header-center {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .search-form-header {
        margin: 0;
        display: flex;
        align-items: center;
    }

    .search-form-header input[type="text"] {
        width: 200px;
        margin-right: 0.5em;
        vertical-align: middle;
    }

    .search-form-header input[type="submit"] {
        vertical-align: middle;
    }

    .header-right {
        display: flex;
        align-items: center;
        flex-shrink: 0;
        white-space: nowrap;
        margin-left: 1em;
    }

    .notification-icon {
        margin-right: 1em;
    }
    .notification-icon img {
        vertical-align: middle;
        position: relative;
        top: 2px;
    }

    .admin-username {
        color: #dc3545 !important;
        font-weight: bold;
    }

    .admin-list-container {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1em;
        margin-bottom: 1em;
    }

    .dropdown-container {
        position: relative;
        display: inline-block;
        white-space: nowrap;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background-color: #f9f9f9;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
        border-radius: 0.25rem;
        padding: 0.5em 0;
    }

    .dropdown-content a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }

    .dropdown-content a:hover {
        background-color: #f1f1f1;
    }

    .user-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        vertical-align: middle;
    }

    .comment-item {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1em;
        margin-bottom: 1em;
    }

    .comment-header {
        display: flex;
        align-items: center;
        margin-bottom: 1em;
    }

    .comment-meta-and-actions {
        display: flex;
        flex-grow: 1;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .user-icon-link {
        flex-shrink: 0;
        margin-right: 1em;
        vertical-align: middle;
    }

    .comment-body {
        flex-grow: 1;
    }

    .comment-meta {
        font-size: 0.8em;
        color: #6c757d;
    }

    .comment-meta small {
        white-space: nowrap;
    }

    .comment-meta form {
        margin: 0;
    }

    .comment-actions {
        margin-left: auto;
    }

    .text-red {
        color: #dc3545;
    }
    .text-large {
        font-size: 1.2em;
    }
    .text-blue {
        color: #007bff;
    }

    #toggle-post-form-btn {
        padding: 0.5em 1em;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        background-color: #007bff;
        color: #fff;
        font-size: 1em;
        display: flex;
        align-items: center;
        gap: 0.5em;
    }

    #toggle-post-form-btn:hover {
        background-color: #0056b3;
    }

    .hidden {
        display: none;
    }

    .template-dropdown {
        position: relative;
        display: inline-block;
    }

    .template-select-btn {
        background-color: #6c757d;
        color: white;
        padding: 8px 12px;
        font-size: 0.9em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .template-select-btn:hover {
        background-color: #5a6268;
    }

    .template-dropdown-content {
        position: absolute;
        right: 0;
        background-color: #f9f9f9;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
        border-radius: 4px;
        overflow: hidden;
    }

    .template-dropdown-content a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }

    .template-dropdown-content a:hover {
        background-color: #f1f1f1;
    }

    @media (max-width: 768px) {
        body { padding-top: 60px; }
        .comments, .comment-item, .post-detail, .post { max-width: 95%; margin-left: auto; margin-right: auto; }
        .header-content { padding: 0 5px; flex-wrap: nowrap; justify-content: space-between; }
        .header-left { order: 0; }
        .header-left h1 { font-size: 1.2em; margin-right: 5px; }
        .header-right { order: 2; margin-left: 5px; flex-shrink: 0; }
        .header-center { order: 1; width: 100%; margin-top: 0; margin-left: 0; justify-content: center; }
        .search-form-header { width: 60%; justify-content: center; }
        .search-form-header input[type="text"] { width: 120px; }
        .search-form-header input[type="submit"] { padding: 0.4em 0.8em; }
        .notification-icon { margin-right: 3px; }
        .user-icon { width: 40px; height: 40px; }
        .dropdown-content { right: 10px; top: 50px; min-width: 150px; }
        .comment-content { max-height: 80px; }
    }


/* --- モーダル用のCSS --- */
　　#editor-overlay {
        display: flex; /* ▼▼▼ この行を追加 ▼▼▼ */
    　　position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    　　background-color: rgba(0, 0, 0, 0.7); z-index: 2000;
    　　align-items: center; justify-content: center;
　　}
　　#editor-modal {
   	 background-color: white; width: 90%; height: 70%; max-width: 600px;
   	 padding: 1em; border-radius: 8px; display: flex; flex-direction: column;
    	box-sizing: border-box; /* ★padding計算のため、これは追加・維持します */
　　}
　　#modal-textarea {
    	width: 100%; height: 100%; flex-grow: 1; border: 1px solid #ccc;
    	resize: none; margin-bottom: 1em; padding: 0.5em; box-sizing: border-box; font-size: 1em;
    	-webkit-appearance: none; /* iOSでの見た目のリセット */
　　}
    #modal-done-btn {
        padding: 0.8em 1em; border: none; border-radius: 4px;
        background-color: #007bff; color: white; cursor: pointer;
        -webkit-appearance: none; /* iOSでの見た目のリセット */
    }


/* ▼▼▼ UECreviewフォーム用CSS ▼▼▼ */
    #uecreview-form-container .uec-form-set {
        border: 1px solid #e0e0e0;
        padding: 1.5em;
        margin-bottom: 1.5em;
        border-radius: 0.25rem;
        background-color: #fdfdfd;
    }
    #uecreview-form-container h3 {
        margin-top: 0;
        padding-bottom: 0.5em;
        border-bottom: 1px solid #eee;
    }
    #uecreview-form-container label {
        display: block;
        margin-top: 1em;
        margin-bottom: 0.3em;
        font-weight: bold;
        font-size: 0.9em;
    }
    /* UECreviewフォーム内の入力欄が既存のスタイルを継承するように調整 */
    #uecreview-form-container input[type="text"],
    #uecreview-form-container select,
    #uecreview-form-container textarea {
        width: 100%;
        padding: 0.5em;
        box-sizing: border-box;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        font-size: 1em;
    }
    #uecreview-form-container textarea {
        min-height: 100px;
        resize: vertical; /* リサイズを許可 */
    }
    #uecreview-form-container select {
        height: auto;
    }
/* ▲▲▲ UECreviewフォーム用CSS ▲▲▲ */



    </style>
</head>
<body>
 <div class="header">
        <div class="header-content">
            <div class="header-left">
                <div style="white-space: nowrap;">
                    <h1><a href="{{ url_for('index') }}" style="text-decoration: none; color: inherit;">UEC 掲示板</a></h1>
                </div>
            </div>
            <div class="header-center">
                {% if request.endpoint != 'login' and request.endpoint != 'register' %}
                    <form method="POST" action="{{ url_for('search') }}" class="search-form-header">
                        {{ search_form.csrf_token }}
                        {{ search_form.search_query.label(style="display: none;") }}
                        {{ search_form.search_query(size=20) }}
                        {{ search_form.submit }}
                    </form>
                {% endif %}
            </div>
            <div class="header-right">
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('show_notifications') }}" style="margin-right: 1em;">
                        {% if current_user.has_unread_notifications() %}
                            <img src="{{ url_for('static', filename='icons/notification_unread.png') }}" alt="未読通知" style="width: 20px; height: 20px;">
                        {% else %}
                            <img src="{{ url_for('static', filename='icons/notification.png') }}" alt="通知" style="width: 20px; height: 20px;">
                        {% endif %}
                    </a>
                    <div class="dropdown-container">
                        <a href="#">
                            {% if current_user.icon_url %}
                                <img src="{{ current_user.icon_url }}" alt="{{ current_user.username }}のアイコン" class="user-icon">
                            {% else %}
                                <img src="{{ url_for('static', filename='icons/default_icon.png') }}" alt="デフォルトアイコン" class="user-icon">
                            {% endif %}
                        </a>
                        <div class="dropdown-content">
                            <a href="{{ url_for('user_profile', username=current_user.username) }}">プロフィール</a>
                            <a href="{{ url_for('edit_profile', username=current_user.username) }}">プロフィールの編集</a>
                            <a href="{{ url_for('show_bookmarks') }}">ブックマーク一覧</a>
                            {% if current_user.is_admin %}
                                <a href="{{ url_for('admin_dashboard') }}">管理者ダッシュボード</a>
                            {% endif %}
                            <a href="{{ url_for('logout') }}">ログアウト</a>
                        </div>
                    </div>
                {% else %}
                    <div>
                        <a href="{{ url_for('login') }}">ログイン</a> |
                        <a href="{{ url_for('register') }}">ユーザー登録</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <main>
        <div class="container">
            {% block content %}{% endblock %}
        </div>
    </main>

　　<div id="editor-overlay" class="hidden">
    　　<div id="editor-modal">

        　　<div id="modal-header" style="display: flex; justify-content: flex-end; padding-bottom: 1em;">
            　　<button id="modal-done-btn">完了</button>
        　　</div>
        　　<textarea id="modal-textarea"></textarea>

        </div>
　　</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- 1. ヘルパー関数と共通の要素を取得 ---
    const resizeTextarea = (textarea) => {
        if (!textarea) return;
        textarea.style.height = 'auto';
        const maxHeight = parseInt(window.getComputedStyle(textarea).maxHeight, 10);
        const scrollHeight = textarea.scrollHeight;
        if (maxHeight > 0 && scrollHeight > maxHeight) {
            textarea.style.height = maxHeight + 'px';
            textarea.style.overflowY = 'auto';
        } else {
            textarea.style.height = scrollHeight + 'px';
            textarea.style.overflowY = 'hidden';
        }
    };

    const headerDropdownContainer = document.querySelector('.dropdown-container');
    const toggleButton = document.getElementById('toggle-post-form-btn');
    const postFormContainer = document.getElementById('post-form-container');
    const imageInput = document.getElementById('image');
    
    // --- 2. モーダルとテキストエリア関連の要素を取得 ---
    const allEditableTextareas = document.querySelectorAll('.auto-resize-textarea');
    const editorOverlay = document.getElementById('editor-overlay');
    const modalTextarea = document.getElementById('modal-textarea');
    const modalDoneBtn = document.getElementById('modal-done-btn');
    const isMobile = window.innerWidth <= 768;
    let activeTextarea = null;

    // --- 3. イベントリスナーの設定 ---
    
    // ヘッダーのドロップダウン処理
    if (headerDropdownContainer) {
        const headerDropdownContent = headerDropdownContainer.querySelector('.dropdown-content');
        if (headerDropdownContent) {
            headerDropdownContainer.querySelector('a').addEventListener('click', function(event) {
                event.preventDefault(); event.stopPropagation();
                const isHidden = headerDropdownContent.style.display === 'none' || headerDropdownContent.style.display === '';
                headerDropdownContent.style.display = isHidden ? 'block' : 'none';
            });
        }
    }

    // 「新しい投稿をする」ボタンの処理
    if (toggleButton && postFormContainer) {
        toggleButton.addEventListener('click', function() {
            postFormContainer.classList.toggle('hidden');
            if (postFormContainer.classList.contains('hidden')) {
                toggleButton.innerHTML = '新しい投稿をする <i class="fas fa-plus"></i>';
            } else {
                toggleButton.innerHTML = 'フォームを閉じる <i class="fas fa-minus"></i>';
            }
        });
    }

    // 完了ボタンの処理
    if (modalDoneBtn) {
        modalDoneBtn.addEventListener('click', () => {
            if (activeTextarea) {
                activeTextarea.value = modalTextarea.value;
                resizeTextarea(activeTextarea);
            }
            // ▼▼▼ ② ここから修正 ▼▼▼
            // 意図: 背景のスクロール禁止を解除します。
            document.body.style.overflow = '';
            // ▲▲▲ ② ここまで修正 ▲▲▲
            editorOverlay.classList.add('hidden');
            activeTextarea = null;
        });
    }

    if (isMobile) {
        // --- スマホの場合：モーダルを開く処理 ---
        allEditableTextareas.forEach((textarea, index) => {
            textarea.addEventListener('focus', (e) => {
                e.preventDefault();
                activeTextarea = e.target;
                modalTextarea.value = activeTextarea.value;

                // ▼▼▼ ② ここから修正 ▼▼▼
                // 意図: モーダル表示時に背景をスクロールできないようにします。
                document.body.style.overflow = 'hidden';
                // ▲▲▲ ② ここまで修正 ▲▲▲
                
                editorOverlay.classList.remove('hidden');
                
                setTimeout(() => modalTextarea.focus(), 100);
            });
        });
    } else {
        // --- PCの場合：インラインでの自動リサイズ ---
        allEditableTextareas.forEach(textarea => {
            textarea.addEventListener('input', () => resizeTextarea(textarea));
            setTimeout(() => resizeTextarea(textarea), 100);
        });
    }

    // --- 4. テンプレート機能の処理 ---
    const allTemplateDropdowns = document.querySelectorAll('.template-dropdown');
    allTemplateDropdowns.forEach(dropdown => {
        const selectBtn = dropdown.querySelector('.template-select-btn');
        const dropdownContent = dropdown.querySelector('.template-dropdown-content');
        if(selectBtn && dropdownContent) {
            selectBtn.addEventListener('click', function(event) {
                event.stopPropagation();
                dropdownContent.classList.toggle('hidden');
            });
        }
    });


    // UECreviewフォームを生成する関数
    function createUecReviewForm(count, container, titleInput, templateTitle, existing_data = []) {
        if (!container) return;
        
        // タイトルを設定（新規作成時、かつ既存データがない時のみ）
        if (titleInput && templateTitle && existing_data.length === 0) {
            titleInput.value = templateTitle;
        }
        
        // コンテナをクリア
        container.innerHTML = '';
        
        // フォームセットを生成
        for (let i = 0; i < count; i++) {
            const formSet = document.createElement('div');
            formSet.className = 'uec-form-set';
            
            let gradesOptions = ['秀', '優', '良', '可', '不可', '（未評価）']
                .map(g => `<option value="${g}">${g}</option>`).join('');

            // 担当教員フィールドを含むHTML
            formSet.innerHTML = `
                <h3>科目 ${i + 1}</h3>
                <div>
                    <label for="uec-subject-${i}">科目名:</label>
                    <input type="text" id="uec-subject-${i}" class="uec-subject" placeholder="例：〇〇論">
                </div>
                <div>
                    <label for="uec-teacher-${i}">担当教員:</label>
                    <input type="text" id="uec-teacher-${i}" class="uec-teacher" placeholder="例：〇〇 先生">
                </div>
                <div>
                    <label for="uec-grade-${i}">成績:</label>
                    <select id="uec-grade-${i}" class="uec-grade">
                        ${gradesOptions}
                    </select>
                </div>
                <div>
                    <label for="uec-review-body-${i}">本文 (レビュー):</label>
                    <textarea id="uec-review-body-${i}" class="uec-review-body" placeholder="例：テストの難易度、課題について等"></textarea>
                </div>
            `;
            
            container.appendChild(formSet); // ★先にDOMに追加

            // データをフォームに埋め込む処理
            const currentData = existing_data[i];
            if (currentData) {
                // formSet（今追加した要素）の中を検索する
                formSet.querySelector('.uec-subject').value = currentData.subject || '';
                formSet.querySelector('.uec-teacher').value = currentData.teacher || '';
                formSet.querySelector('.uec-grade').value = currentData.grade || '（未評価）';
                formSet.querySelector('.uec-review-body').value = currentData.body || '';
            }
        }
        
        // UECreviewコンテナを表示し、元の本文欄を非表示に
        container.classList.remove('hidden');
        const originalContentField = container.closest('form').querySelector('#content-field-original');
        if (originalContentField) {
            originalContentField.classList.add('hidden');
            
            const originalTextarea = originalContentField.querySelector('.auto-resize-textarea');
            if (originalTextarea) {
                originalTextarea.required = false; // required属性を解除
            }
        }
    } // <-- createUecReviewForm 関数の閉じカッコ


// UECreviewフォームから本文を組み立てる関数
    function buildUecReviewContent(container) {
        let combinedContent = '';
        const formSets = container.querySelectorAll('.uec-form-set');
        
        formSets.forEach((set, index) => {
            const subject = set.querySelector('.uec-subject').value;
            const teacher = set.querySelector('.uec-teacher').value; // <-- ★これを追加
            const grade = set.querySelector('.uec-grade').value;
            const body = set.querySelector('.uec-review-body').value;

            let reviewString = `<span class="text-large">**${subject || 'ここに科目名を入力'}**</span> `;
            reviewString += `成績:<span class="text-red text-large">**${grade}**</span> `;
            // ▼▼▼ teacher 変数を使うように修正 ▼▼▼
            reviewString += `担当教員:${teacher || 'ここに担当教員名を入力'}\n`;
            reviewString += `${body || '本文を入力'}`;
            
            combinedContent += reviewString;
            
            if (index < formSets.length - 1) {
                combinedContent += '\n\n---\n\n'; 
            }
        });
        
        return combinedContent;
    }

    // テンプレート選択時の処理
    if (typeof TEMPLATES_DATA !== 'undefined' && TEMPLATES_DATA.length > 0) {
        document.querySelectorAll('.template-item').forEach(item => {
            item.addEventListener('click', function(event) {
                event.preventDefault();
                const templateIndex = parseInt(item.dataset.index, 10);
                const template = TEMPLATES_DATA[templateIndex];
                if (!template) return;

                // フォーム（投稿フォーム or 編集フォーム）を特定
                const parentForm = this.closest('form');
                if (!parentForm) return;

                const titleInput = parentForm.querySelector('input[name="title"]');
                const originalContentTextarea = parentForm.querySelector('.auto-resize-textarea'); // 元の本文
                const uecReviewContainer = parentForm.querySelector('#uecreview-form-container'); // UECコンテナ
                const originalContentField = parentForm.querySelector('#content-field-original'); // 元の本文のラッパー

                // モバイル用のモーダル判定 (元のロジックを尊重)
                let contentTextarea;
                if (isMobile && editorOverlay && editorOverlay.style.display === 'flex') {
                    contentTextarea = document.getElementById('modal-textarea');
                } else {
                    contentTextarea = originalContentTextarea;
                }

                if (template.name === 'UECreview') {
                    const countStr = prompt('何科目書きますか？ (最大20科目)', '1');
                    if (countStr) {
                        const halfWidthStr = countStr.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                        const count = parseInt(halfWidthStr, 10);
                        if (!isNaN(count) && count > 0 && count <= 20) { // 上限を設定
                            // UECreviewフォームを生成
                            createUecReviewForm(count, uecReviewContainer, titleInput, template.title);
                            // モバイルモーダルが開いていたら閉じる (UECreviewは専用フォームを使うため)
                            if (isMobile && editorOverlay && editorOverlay.style.display === 'flex') {
                                 document.body.style.overflow = '';
                                 editorOverlay.style.display = 'none';
                                 activeTextarea = null;
                            }
                        } else { alert('有効な数字(1〜20)を入力してください。'); }
                    }
                } else {
                    // --- 通常のテンプレートが選択された場合 ---
                    
                    // UECreviewフォームを隠す
                    if (uecReviewContainer) uecReviewContainer.classList.add('hidden');
                    if (uecReviewContainer) uecReviewContainer.innerHTML = '';
                    // 元の本文欄を表示
			if (originalContentField) {
                        originalContentField.classList.remove('hidden');

                        // ▼▼▼ この3行を '}' の内側に移動し、余計な ')' を削除 ▼▼▼
                        const originalTextarea = originalContentField.querySelector('.auto-resize-textarea');
                        if (originalTextarea) {
                            originalTextarea.required = true; // required属性を元に戻す
                        }
                    } 

                    if (titleInput) titleInput.value = template.title;
                    if (contentTextarea) {
                        contentTextarea.value = template.body;
                        if (isMobile && editorOverlay && editorOverlay.style.display === 'flex') {
                            // モーダルが開いていればそちらに反映
                        } else if (originalContentTextarea) {
                            // PCまたはモーダルが閉じていれば通常のテキストエリア
                            resizeTextarea(originalContentTextarea);
                        }
                    }
                }
                
                // ドロップダウンを閉じる
                const parentDropdownContent = item.closest('.template-dropdown-content');
                if (parentDropdownContent) { parentDropdownContent.classList.add('hidden'); }
            });
        });
    }
    // --- 5. その他の機能 ---
    // 画像アップロード時のファイル名表示処理
    if (imageInput) {
        const filenameDisplay = document.getElementById('image-filename-display');
        const editFilenameDisplay = document.getElementById('edit-image-filename-display');
        imageInput.addEventListener('change', function() {
            const file = this.files[0];
            const filename = file ? file.name : '';
            if (filenameDisplay) { filenameDisplay.textContent = filename; }
            if (editFilenameDisplay) { 
                const currentImageText = document.querySelector('#edit-image-filename-display').getAttribute('data-current-image') || '画像がありません';
                editFilenameDisplay.textContent = file ? `選択中: ${filename}` : currentImageText;
             }
        });
    }

    // ブックマークボタンの処理
    document.querySelectorAll('.bookmark-toggle-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const form = this.closest('.bookmark-form');
            const postId = form.dataset.postId;
            const url = `{{ url_for('bookmark_post', post_id=0) }}`.slice(0, -1) + postId;
            fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/json' } })
            .then(response => response.json())
            .then(data => {
                const iconSpan = document.getElementById(`bookmark-icon-${postId}`);
                if (iconSpan) {
                    if (data.is_bookmarked) {
                        iconSpan.innerHTML = '<img src="{{ url_for("static", filename="icons/bookmarked.png") }}" alt="ブックマーク済み" style="width: 20px; height: 20px;">';
                    } else {
                        iconSpan.innerHTML = '<img src="{{ url_for("static", filename="icons/bookmark.png") }}" alt="ブックマーク" style="width: 20px; height: 20px;">';
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // コメント削除処理
document.querySelectorAll('.delete-comment-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const commentId = this.dataset.commentId;
            // ▼▼▼ 正しくはバッククォート (`) ▼▼▼
            const url = `/comment/${commentId}/delete`;
            if (confirm('本当にこのコメントを削除しますか？')) {
                fetch(url, { method: 'POST', headers: {'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/json'} })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const commentElement = document.getElementById(`comment-${commentId}`);
                        if (commentElement) {
                            commentElement.style.opacity = '0';
                            setTimeout(() => commentElement.remove(), 300);
                        }
                        const commentCountHeader = document.getElementById('comment-count-header');
                        if (commentCountHeader) { commentCountHeader.innerText = `コメント (${data.remaining_comments})`; }
                        const titleCommentCount = document.getElementById('title-comment-count');
                        if (titleCommentCount) { titleCommentCount.innerText = `コメント数(${data.remaining_comments})`; }
                    } else { alert('コメントの削除に失敗しました。'); }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    });

// --- 6. フォーム送信時の処理 (ここから新規追加) ---
    // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
    
    // ページ内のすべての投稿/編集フォームを取得
    const postForms = document.querySelectorAll('form[method="POST"][enctype="multipart/form-data"]');
    
    postForms.forEach(form => {
        form.addEventListener('submit', function(event) {
            const uecReviewContainer = form.querySelector('#uecreview-form-container');
            const originalContentTextarea = form.querySelector('.auto-resize-textarea'); // 元の本文

            // UECreviewコンテナが表示されている（アクティブである）場合
            if (uecReviewContainer && !uecReviewContainer.classList.contains('hidden') && originalContentTextarea) {
                
                // 1. UECreviewフォームから本文を組み立てる
                const combinedContent = buildUecReviewContent(uecReviewContainer);
                
                // 2. 元の本文テキストエリアに値を設定する
                originalContentTextarea.value = combinedContent;
                
                // 3. このままデフォルトの送信動作を許可する
            }
            
            // モバイルモーダルが開いている場合の対処 (既存ロジック)
            if (isMobile && editorOverlay && editorOverlay.style.display === 'flex' && activeTextarea) {
                activeTextarea.value = modalTextarea.value;
                resizeTextarea(activeTextarea);
            }
        });
    });


// --- 7. 編集ページ用のUECreviewデータ読み込み ---
    
    // 編集フォーム（indexの投稿フォームではない）が存在する場合のみ実行
    const editForm = document.querySelector('form[method="POST"][enctype="multipart/form-data"]');
    // const postFormContainer = ... (二重宣言になるため削除)
    
    if (editForm && !postFormContainer) { // (postFormContainerはスクリプト上部 で宣言済み)
        // サーバーから渡されたJSONデータがあるか確認
        {% if uec_review_data_json is defined and uec_review_data_json %}
            try {
                // テンプレートに埋め込まれたJSONをパース
                const reviewData = {{ uec_review_data_json | safe }};
                
                if (reviewData && reviewData.length > 0) {
                    // フォーム生成に必要な要素を取得
                    const titleInput = editForm.querySelector('input[name="title"]');
                    const uecReviewContainer = editForm.querySelector('#uecreview-form-container'); 
                    
                    // UECreviewフォームをデータ付きで生成 (5引数の関数を呼ぶ)
                    createUecReviewForm(reviewData.length, uecReviewContainer, titleInput, null, reviewData);
                }
            } catch (e) {
                console.error("UECreview データのパースに失敗しました:", e);
            }
        {% endif %}
    }
    // --- ドロップダウンを閉じるグローバルなクリック処理 ---
    document.addEventListener('click', function(event) {
        if (headerDropdownContainer && !headerDropdownContainer.contains(event.target)) {
            const content = headerDropdownContainer.querySelector('.dropdown-content');
            if (content) content.style.display = 'none';
        }
        if (!event.target.closest('.template-dropdown')) {
            document.querySelectorAll('.template-dropdown-content').forEach(content => {
                content.classList.add('hidden');
            });
        }
    });
}); // <-- ★★★ DOMContentLoaded はここで閉じる ★★★



</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</body>
</html>