<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>UEC 掲示板</title>

    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='icons/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ url_for('static', filename='icons/android-chrome-192x192.png') }}">

    {% if templates_for_js %}
    <script>
    const TEMPLATES_DATA = {{ templates_for_js | safe }};
    </script>
    {% endif %}
    <link rel="manifest" href="{{ url_for('manifest') }}">
    <style>
    /*----------------------------------*/
    /* 全体的な設定とリセット */
    /*----------------------------------*/
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        line-height: 1.4;
        color: #333;
        background-color: #f8f9fa;
        padding-top: 70px;
    }

    a { color: #007bff; text-decoration: none; }

    a:hover { text-decoration: underline; }


    /* コンテナの幅を制限 */
    .container {
        max-width: 800px;
        margin: 2em auto;
        padding: 1em;
    }

    /* ボックスの共通スタイル */
    .post, .post-form, .post-detail, .comment-container, .comments, .comment-item, .form-field, .user-info {
        position: relative; /* テンプレートボタンの配置に必要 */
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1.5em;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    .post, .post-form, .post-detail, .comment-container, .comments, .comment-item, .form-field, .user-info, .content-width-limiter {
        max-width: 770px;
        margin-left: auto;
        margin-right: auto;
        margin-bottom: 1.5em; /* 共通のボトムマージン */
    }

    /* ▼▼▼ 重複していたCSSルールを削除しました (L51-L66) ▼▼▼ */
    /* ▲▲▲ ここまで ▲▲▲ */


    /* タイトルとヘッダー */
    .post h3, .post-detail h1 { margin-top: 0; margin-bottom: 0.5em; font-size: 1.5em; }
    .post-form h2 { margin-top: 0; margin-bottom: 0.5em; padding-bottom: 0.5em; border-bottom: 1px solid #dee2e6; }

    /* 1. 全てのテキストエリアの共通設定 */
    textarea {
        width: 100%;
        padding: 0.5em;
        box-sizing: border-box;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        line-height: 1.4;
        resize: none;
    }

    /* ▼▼▼ ① ここから修正 ▼▼▼ */
    /* 意図: form内のテキスト入力欄のスタイルを定義します。
       width: 100% と box-sizing: border-box; で、textareaと横幅が揃うようになります。*/
    form input[type="text"],form input[type="password"] {
        width: 100%;
        padding: 0.5em;
        box-sizing: border-box;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        font-size: 1em; /* ブラウザごとの差異を吸収 */
        height: auto;
    }
    /* ▲▲▲ ① ここまで修正 ▲▲▲ */


    /* 2. 本文入力・編集用の自動リサイズ設定 */
    .auto-resize-textarea {
        resize: none;
        overflow: hidden;
        max-height: 400px; /* 最大の高さを400pxに設定 */
    }

    /* 3. コメント入力用の設定 (手動リサイズはなし) */
    .comment-textarea {
        min-height: 80px; /* 最低限の高さを確保 */
    }

    /* auto-resize-textareaが最大高さに達した場合、スクロールバーを表示 */
    .auto-resize-textarea:focus {
        overflow-y: auto;
    }


    /* 4. 新規投稿フォーム用の追加スタイル */
    .textarea-content {
        min-height: 100px;
    }
    
    /* 5. 表示される投稿・コメント本文の行間設定 */
    /* --- A. 投稿本文の設定 --- */
     .post-content {
         /* 一覧ページでは高さを制限してスクロールさせる */
         max-height: 200px; /* 200pxを超えたらスクロール */
         overflow-y: auto;  /* スクロールバーを出す */
         border: 1px solid #dee2e6;
         border-radius: 0.25rem;
     }

     /* 詳細ページ(.post-detail)の中にある投稿本文だけは、全表示する */
     .post-detail .post-content {
         max-height: none;
         overflow-y: visible;
     }

    /* --- B. コメント本文の設定--- */
     .comment-content {
         /* JSで折りたたむので、CSSでのスクロールは無効化 */
         max-height: none;
         overflow-y: visible;
         
         /* ▼▼▼ 枠線と背景を復活させる設定 ▼▼▼ */
         border: 1px solid #dee2e6;
         border-radius: 0.25rem;
         background-color: #ffffff;
         padding: 0.8em 1em; /* 内側の余白 */
         /* ▲▲▲ ここまで ▲▲▲ */
         
         margin-top: 5px;
         margin-bottom: 5px;
         width: 100%;
         box-sizing: border-box;
         white-space: pre-wrap;
         line-height: 1.6; 
         overflow-wrap: anywhere;
         word-break: break-word;
         font-size: 1em;
         color: #333;
     }

     /* 共通のベース設定 */
     .post-content, .comment-content {
        padding: 0.8em 1em;
        background-color: #ffffff;
        margin-top: 5px;
        margin-bottom: 5px;
        width: 100%;
        box-sizing: border-box;
        white-space: normal;
        line-height: 1.6; 
        overflow-wrap: anywhere;
        word-break: break-word;
        font-size: 1em;
        color: #333;
        min-height: 0; 
        height: auto;
     }

    .post-content p, .comment-content p {
         margin-top: 0;
         margin-bottom: 0.3em; /* ここを 0 にすれば完全に詰まります。お好みで調整 */
     }

     /* ▼▼▼ 長文コメントの省略表示用CSS ▼▼▼ */
    
    /* 折りたたまれた状態 */
    .comment-content.collapsed {
        max-height: 125px; /* ここで高さを制限 (約6~7行分) */
        overflow: hidden;
        position: relative;
    }

    /* 「全文を表示」ボタンのスタイル */
    .read-more-btn {
        display: block;
        margin-top: 2px;
        margin-left: auto;
        background: none;
        border: none;
        color: #007bff;
        font-size: 0.85em;
        font-weight: bold;
        cursor: pointer;
        padding: 2px 5px;
    }
    
    .read-more-btn:hover {
        text-decoration: underline;
    }

    /* 投稿された画像のスタイル */
    .post-image {
        max-width: 100%;
        height: auto;
        border-radius: 5px;
        margin-top: 15px;
	display: block;
        margin-left: auto;
        margin-right: auto;
    }

    /* 投稿フッター（投稿者情報、ブックマーク）のスタイル */
    .post-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 1em;
        font-size: 0.9em;
        color: #6c757d;
        flex-wrap: wrap; /* 幅が狭いときは無理せず折り返す */
        gap: 10px;       /* どんなに狭くても、日時とボタンの間は10px空ける */
    }
    .post-meta small {
        white-space: nowrap;
    }

    /* ボタンのスタイル */
    input[type="submit"] {
        padding: 0.5em 1em;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        background-color: #007bff;
        color: #fff;
    }
    input[type="submit"]:hover {
        background-color: #0056b3;
    }

    .delete-button {
        font-size: 0.8em;
        padding: 0.2em 0.5em;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
    }
    .delete-button:hover {
        background-color: #c82333;
    }
    .delete-button.yellow {
        background-color: #ffc107;
        color: black;
    }
    .delete-button.yellow:hover {
        background-color: #e0a800;
    }

    /* ページネーション */
    .pagination a {
        padding: 0.5em 0.75em;
        border: 1px solid #dee2e6;
        margin: 0 0.25em;
        border-radius: 0.25rem;
    }
    .pagination a[style="font-weight: bold;"] {
        background-color: #007bff;
        color: #fff;
        border-color: #007bff;
    }

    /*----------------------------------*/
    /* ヘッダーのスタイル */
    /*----------------------------------*/
    .header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background-color: #fff;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 0.5em 0;
    }

    .header-content {
        max-width: 800px;
        margin: auto;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: nowrap;
    }

    .header-left, .header-right {
        display: flex;
        align-items: center;
        flex-wrap: nowrap;
    }

    .header-left h1 {
        margin: 0;
        margin-right: 1em;
    }

    .header-left h1 a {
        text-decoration: none;
        color: inherit;
        white-space: nowrap;
    }

    .header-center {
        flex-grow: 1;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .search-form-header {
        margin: 0;
        display: flex;
        align-items: center;
    }

    .search-form-header input[type="text"] {
        width: 200px;
        margin-right: 0.5em;
        vertical-align: middle;
    }

    .search-form-header input[type="submit"] {
        vertical-align: middle;
    }

    .header-right {
        display: flex;
        align-items: center;
        flex-shrink: 0;
        white-space: nowrap;
        margin-left: 1em;
    }

    .notification-icon {
        margin-right: 1em;
    }
    .notification-icon img {
        vertical-align: middle;
        position: relative;
        top: 2px;
    }

    .admin-username {
        color: #dc3545 !important;
        font-weight: bold;
    }

    .admin-list-container {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1em;
        margin-bottom: 1em;
    }

    .dropdown-container {
        position: relative;
        display: inline-block;
        white-space: nowrap;
    }

    .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        background-color: #f9f9f9;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
        border-radius: 0.25rem;
        padding: 0.5em 0;
    }

    .dropdown-content a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }

    .dropdown-content a:hover {
        background-color: #f1f1f1;
    }

    .user-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        vertical-align: middle;
    }

    .comment-item {
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 1em;
        margin-bottom: 1em;
    }

    .comment-header {
        display: flex;
        align-items: center;
        margin-bottom: 1em;
    }

    .comment-meta-and-actions {
        display: flex;
        flex-grow: 1;
        justify-content: space-between;
        align-items: center;
        width: 100%;
    }

    .user-icon-link {
        flex-shrink: 0;
        margin-right: 1em;
        vertical-align: middle;
    }

    .comment-body {
        flex-grow: 1;
    }

    .comment-meta {
        font-size: 0.8em;
        color: #6c757d;
    }

    .comment-meta small {
        white-space: nowrap;
    }

    .comment-meta form {
        margin: 0;
    }

    .comment-actions {
        margin-left: auto;
    }

    .text-red {
        color: #dc3545;
    }
    .text-large {
        font-size: 1.2em;
    }
    .text-blue {
        color: #007bff;
    }

    #toggle-post-form-btn, #toggle-comment-form-btn {
        padding: 0.5em 1em;
        border: none;
        border-radius: 0.25rem;
        cursor: pointer;
        background-color: #007bff;
        color: #fff;
        font-size: 1em;
        display: flex;
        align-items: center;
        gap: 0.5em;
    }

    #toggle-post-form-btn:hover, #toggle-comment-form-btn:hover {
        background-color: #0056b3;
    }

    .hidden {
        display: none;
    }

    .template-dropdown {
        position: relative;
        display: inline-block;
    }

    .template-select-btn {
        background-color: #6c757d;
        color: white;
        padding: 8px 12px;
        font-size: 0.9em;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .template-select-btn:hover {
        background-color: #5a6268;
    }

    .template-dropdown-content {
        position: absolute;
        right: 0;
        background-color: #f9f9f9;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
        z-index: 1;
        border-radius: 4px;
        overflow: hidden;
    }

    .template-dropdown-content a {
        color: black;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
    }

    .template-dropdown-content a:hover {
        background-color: #f1f1f1;
    }

    /* --- PC用 サイドナビ --- */
    .desktop-nav {
        display: none; /* デフォルトは非表示 */
        position: fixed;
        top: 100px; /* ヘッダーの下 */
        /* 画面中央 + コンテンツ幅半分(400px) + 隙間(20px) */
        left: calc(50% + 420px); 
        width: 60px;
        z-index: 900;
    }

    .desktop-nav ul {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .desktop-nav a {
        display: block;
        padding: 10px;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: all 0.2s ease;
    }

    .desktop-nav a:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    .desktop-nav img {
        width: 40px;
        height: 40px;
        display: block;
    }

/* --- スマホ用 フッターナビ --- */
.mobile-nav {
    display: none; /* デフォルトは非表示 */
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: auto;
    padding-bottom: env(safe-area-inset-bottom); /* iPhoneのバーの高さ分、自動で余白が入ります */
    height: 70px;
    background-color: #ffffff;
    border-top: 1px solid #dee2e6;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
    z-index: 1000;
}

.mobile-nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    justify-content: space-around;
    align-items: center;
    width: 100%;
    height: 70px;
}

/* 当たり判定を大きくする (要求通り) */
.mobile-nav li {
    flex: 1; /* 3等分 */
    height: 100%;
}

.mobile-nav a {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    text-decoration: none;
    color: #555;
    font-size: 0.7em;
    gap: 2px;
}

.mobile-nav a:hover {
    background-color: #f8f9fa;
}

.mobile-nav img {
    width: 28px;
    height: 28px;
}

/* 1024px 以上をPCとみなす */
@media (min-width: 1025px) {
    .desktop-nav {
        display: block;
    }
}

    @media (max-width: 768px) {
        body { 
            padding-top: 60px; 
            padding-bottom: 70px; /* ★ スマホナビの高さ分、余白を追加 ★ */
        }
        
        /* .container に padding を設定して余白を管理します  */
        .container {
            /* padding: 0; (元の設定を削除) */
            padding: 0 10px; /* 左右に10pxのパディングを追加 (この値で余白を調整できます) */
            margin-top: 1em;
            box-sizing: border-box; /* paddingを含めて幅を計算 */
        }
        
        /* .post などの max-width を 100% に戻します */
        /* (親の.containerにpaddingがあるので、子は100%でOK) */
        .post, .post-form, .post-detail, .comment-container, .comments, .comment-item, .form-field, .user-info, .content-width-limiter {
            max-width: 95%; /* 95% から 100% に変更 */
            margin-left: auto; 
            margin-right: auto; 
        }
        /* ▲▲▲ 修正ここまで ▲▲▲ */

        .mobile-nav {
        display: flex;
    }

        .header-content { padding: 0 5px; flex-wrap: nowrap; justify-content: space-between; }
        .header-left { order: 0; }
        .header-left h1 { font-size: 1.2em; margin-right: 5px; }
        .header-right { order: 2; margin-left: 5px; flex-shrink: 0; }
        .header-center { order: 1; width: 100%; margin-top: 0; margin-left: 0; justify-content: center; }
        .search-form-header { width: 60%; justify-content: center; }
        .search-form-header input[type="text"] { width: 120px; }
        .search-form-header input[type="submit"] { padding: 0.4em 0.8em; }
        .notification-icon { margin-right: 3px; }
        .user-icon { width: 40px; height: 40px; }
        .dropdown-content { right: 10px; top: 50px; min-width: 150px; }
        .header-right div {
            font-size: 0.9em; /* 文字サイズを少し小さくする */
        }
    }




/* ▼▼▼ UECreviewフォーム用CSS ▼▼▼ */
    #uecreview-form-container .uec-form-set {
        border: 1px solid #e0e0e0;
        padding: 1.5em;
        margin-bottom: 1.5em;
        border-radius: 0.25rem;
        background-color: #fdfdfd;
    }
    #uecreview-form-container h3 {
        margin-top: 0;
        padding-bottom: 0.5em;
        border-bottom: 1px solid #eee;
    }
    #uecreview-form-container label {
        display: block;
        margin-top: 1em;
        margin-bottom: 0.3em;
        font-weight: bold;
        font-size: 0.9em;
    }
    /* UECreviewフォーム内の入力欄が既存のスタイルを継承するように調整 */
    #uecreview-form-container input[type="text"],
    #uecreview-form-container select,
    #uecreview-form-container textarea {
        width: 100%;
        padding: 0.5em;
        box-sizing: border-box;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        font-size: 1em;
    }
    #uecreview-form-container textarea {
        min-height: 100px;
        resize: none !important;      /* リサイズハンドルを消す */
        overflow-y: hidden !important; /* スクロールバーを出さない */
    }
    #uecreview-form-container select {
        height: auto;
    }
/* ▲▲▲ UECreviewフォーム用CSS ▲▲▲ */

/* ▼▼▼ タグ表示用CSS ▼▼▼ */
.tag-container {
    display: flex;
    flex-wrap: wrap;
    gap: 8px; /* タグ間の隙間 */
    margin: 10px 0;
}
.tag-box {
    display: inline-block;
    padding: 3px 10px;
    font-size: 0.85em;
    font-weight: 500;
    color: #333;
    background-color: #fff;
    border: 1px solid #333; 
    border-radius: 15px; 
    text-decoration: none;
    white-space: nowrap;
}

a.tag-box:hover {
    background-color: #f1f1f1;
    border-color: #007bff;
    color: #007bff;
    text-decoration: none; /* 下線はつけない */
}

/* ▲▲▲ タグ表示用CSS ▲▲▲ */

/* ▼▼▼ [前回追加] 最近のタグ ドロップダウン用CSS ▼▼▼ */
.recent-tags-dropdown {

    position: absolute;
    right: 0;
    top: 100%; /* 親要素のすぐ下に表示 */
    background-color: #f9f9f9;
    min-width: 160px;
    box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
    z-index: 10;
    border-radius: 0.25rem;
    padding: 0.5em 0;
    margin-top: 2px;
}
.recent-tags-dropdown a {
    color: black;
    padding: 8px 12px;
    text-decoration: none;
    display: block;
    font-size: 0.9em;
}
.recent-tags-dropdown a:hover {
    background-color: #f1f1f1;
}
.recent-tags-dropdown .recent-tag-item {
    cursor: pointer;
}

/* 回覧板アイコンのコンテナ */
.kairanban-icon-container {
    position: relative; /* 疑似要素の基準位置 */
    display: inline-block; /* img要素に合わせる */
}

/* 未読がある場合の赤丸 */
.kairanban-icon-container.has-unread-kairanban::after {
    content: ''; /* 疑似要素にはcontentが必要 */
    position: absolute;
    top: -5px; /* アイコンの右上外側に配置 */
    right: -5px; /* アイコンの右上外側に配置 */
    width: 7px; /* 赤丸の直径 */
    height: 7px; /* 赤丸の直径 */
    background-color: #dc3545; /* 赤色 */
    border-radius: 50%; /* 円形にする */
    border: 1.5px solid #fff; /* 白い縁取り */
    z-index: 10; /* 他の要素の上に表示 */
}

/* スマホ版のフッターアイコンに対する調整 */
.mobile-nav .kairanban-icon-container.has-unread-kairanban::after {
    top: -2px; /* スマホ版では少し調整 */
    right: -2px;
}

.affiliation-form-container {
    display: flex;
    flex-wrap: wrap;  /* スマホなどで折り返す */
    gap: 15px;      /* 各ドロップダウン間の隙間 */
    margin-bottom: 1.5em; /* .form-field と同じマージン */
}

.affiliation-form-container .form-field {
    flex: 1;            /* 均等に横幅を伸ばす */
    min-width: 180px;   /* 最小幅（これを下回ると折り返す） */
    margin-bottom: 0;   /* 親がマージンを持つので子は0に */
}

/* ドロップダウン自体がコンテナ幅に広がるようにする */
.affiliation-form-container .form-field select {
    width: 100%;
    padding: 0.5em;
    box-sizing: border-box;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    height: auto;
    font-size: 1em;
}

.file-upload-btn {
    padding: 0.5em 1em;
    border: none;
    border-radius: 0.25rem;
    cursor: pointer;
    background-color: #6c757d; /* 既存のボタン色に合わせる */
    color: #fff;
    display: inline-block;
    font-size: 0.9em;
}
.file-upload-btn:hover {
    background-color: #5a6268;
}

/* リンクカードのスタイル */
    .link-card {
        display: flex;
        border: 1px solid #e1e8ed;
        border-radius: 12px;
        overflow: hidden;
        text-decoration: none !important;
        color: #333;
        margin-top: 0.5em;
        margin-bottom: 0.5em;
        background-color: #fff;
        transition: background-color 0.2s;
        max-width: 100%;
        height: 120px; /* 高さを固定 */
    }
    .link-card:hover {
        background-color: #f8f9fa;
        color: #333;
    }
    .link-card-image {
        width: 120px; /* 正方形に近い形 */
        height: 100%;
        background-size: cover;
        background-position: center;
        background-color: #f0f0f0;
        flex-shrink: 0;
        border-right: 1px solid #e1e8ed;
    }
    .link-card-content {
        padding: 10px 15px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        overflow: hidden;
    }
    .link-card-title {
        font-weight: bold;
        font-size: 1em;
        margin-bottom: 5px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .link-card-desc {
        font-size: 0.85em;
        color: #657786;
        display: -webkit-box;
        -webkit-line-clamp: 2; /* 2行まで表示 */
        -webkit-box-orient: vertical;
        overflow: hidden;
        margin-bottom: 5px;
    }
    .link-card-url {
        font-size: 0.75em;
        color: #8899a6;
    }
    /* ▼▼▼ 追加: リンクカードをまとめるコンテナ ▼▼▼ */
    .link-card-container {
        margin-top: 10px;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        gap: 10px; /* カードが複数の場合の隙間 */
        width: 100%;
    }
    
    /* スマホ用調整 */
    @media (max-width: 480px) {
        .link-card { height: 100px; }
        .link-card-image { width: 100px; }
        .link-card-title { font-size: 0.9em; }
    }

    /* ▼▼▼ 画像拡大モーダル用CSS ▼▼▼ */
    #image-modal {
        display: none; /* デフォルト非表示 */
        position: fixed;
        z-index: 2000; /* ヘッダーより上 */
        padding-top: 0;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: rgba(0,0,0,0.9); /* 黒背景（少し透過） */
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    /* 拡大画像 */
    .modal-content-img {
        margin: auto;
        display: block;
        width: auto;
        height: auto;
        max-width: 95%;
        max-height: 95%;
        object-fit: contain;
        animation-name: zoom;
        animation-duration: 0.3s;
    }

    /* ズームアニメーション */
    @keyframes zoom {
        from {transform:scale(0.8); opacity: 0;}
        to {transform:scale(1); opacity: 1;}
    }

    /* 閉じるボタン */
    #close-modal {
        position: absolute;
        top: 20px;
        right: 30px;
        color: #f1f1f1;
        font-size: 40px;
        font-weight: bold;
        transition: 0.3s;
        cursor: pointer;
        z-index: 2001;
        background: rgba(0, 0, 0, 0.5);
        width: 50px;
        height: 50px;
        line-height: 50px;
        text-align: center;
        border-radius: 50%;
    }

    #close-modal:hover,
    #close-modal:focus {
        color: #bbb;
        text-decoration: none;
        cursor: pointer;
    }
    
    /* カーソルをズームインに変更（投稿画像） */
    .post-image {
        cursor: zoom-in;
    }

    .review-tag-icon {
        width: 16px; 
        height: 16px; 
        vertical-align: middle; 
        margin-right: 4px;
        margin-bottom: 2px;
    }

</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
 <div class="header">
        <div class="header-content">
            <div class="header-left">
                <div style="white-space: nowrap;">
                    <h1><a href="{{ url_for('index') }}" style="text-decoration: none; color: inherit;">UEC 掲示板</a></h1>
                </div>
            </div>
            <div class="header-center">
                {% if request.endpoint != 'login' and request.endpoint != 'register' %}
                    {% if request.endpoint == 'review_db' %}
                        <form method="GET" action="{{ url_for('review_db') }}" class="search-form-header">
                            <input type="text" name="search_query" placeholder="DB内検索(科目・教員)" value="{{ request.args.get('search_query', '') }}" size="20" style="width: 200px; margin-right: 0.5em;">
                            <input type="submit" value="検索">
                        </form>
                        {% else %}
                        <form method="POST" action="{{ url_for('search') }}" class="search-form-header">
                            {{ search_form.csrf_token }}
                            {{ search_form.search_query.label(style="display: none;") }}
                            {{ search_form.search_query(size=20) }}
                            {{ search_form.submit }}
                        </form>
                    {% endif %}
                {% endif %}
            </div>
            <div class="header-right">
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('show_notifications') }}" style="margin-right: 1em;">
                        {% if current_user.has_unread_notifications() %}
                            <img src="{{ url_for('static', filename='icons/notification_unread.png') }}" alt="未読通知" style="width: 20px; height: 20px;">
                        {% else %}
                            <img src="{{ url_for('static', filename='icons/notification.png') }}" alt="通知" style="width: 20px; height: 20px;">
                        {% endif %}
                    </a>
                    <div class="dropdown-container">
                        <a href="#">
                            {% if current_user.icon_url %}
                                <img src="{{ current_user.icon_url }}" alt="{{ current_user.username }}のアイコン" class="user-icon">
                            {% else %}
                                <img src="{{ url_for('static', filename='icons/default_icon.png') }}" alt="デフォルトアイコン" class="user-icon">
                            {% endif %}
                        </a>
                        <div class="dropdown-content">
                            <a href="{{ url_for('user_profile', username=current_user.username) }}">プロフィール</a>
                            <a href="{{ url_for('review_db') }}">UECreviewDB</a>
                            <a href="{{ url_for('show_bookmarks') }}">ブックマーク一覧</a>
                            
                            {% if current_user.is_admin %}
                                <a href="{{ url_for('admin_dashboard') }}">管理者ダッシュボード</a>
                            {% endif %}
                            
                            <a href="{{ url_for('settings') }}">設定</a>
                            
                            <hr style="margin: 5px 0;">
                            
                            <a href="{{ url_for('logout') }}" style="color: #dc3545;">ログアウト</a>
                        </div>
                    </div>
                {% else %}
                    <div>
                        <a href="{{ url_for('login') }}">ログイン</a> |
                        <a href="{{ url_for('register') }}">ユーザー登録</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <main>
        <div class="container">

            {% with messages = get_flashed_messages() %}
              {% if messages %}
                <div id="flash-message-container" class="post-form" style="background-color: #e6f7ff; border-color: #b3e0ff; margin-bottom: 1.5em; position: relative;">
                  
                  <button id="dismiss-flash-btn" type="button" style="position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5em; cursor: pointer; color: #0056b3; padding: 0 5px; line-height: 1;">
                    &times; </button>

                  {% for message in messages %}
                    <p style="margin: 0; padding-right: 30px;">{{ message }}</p>
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}
            {% block content %}{% endblock %}
        </div>
    </main>

        <nav class="desktop-nav">
            <ul>
                <li>
                    <a href="{{ url_for('index') }}" title="ホーム">
                        <img src="{{ url_for('static', filename='icons/home.png') }}" alt="ホーム">
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('kairanban_index') }}" title="回覧板">
                        <div class="kairanban-icon-container {% if has_unread_kairanban %}has-unread-kairanban{% endif %}">
                            <img src="{{ url_for('static', filename='icons/note.png') }}" alt="回覧板">
                        </div>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('hub_index') }}" title="便利機能">
                        <img src="{{ url_for('static', filename='icons/development.png') }}" alt="便利機能">
                    </a>
                </li>
            </ul>
        </nav>

        <nav class="mobile-nav">
            <ul>
                <li>
                    <a href="{{ url_for('hub_index') }}">
                        <img src="{{ url_for('static', filename='icons/development.png') }}" alt="便利機能">
                        <span>機能</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('index') }}">
                        <img src="{{ url_for('static', filename='icons/home.png') }}" alt="ホーム">
                        <span>ホーム</span>
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('kairanban_index') }}">
                        <div class="kairanban-icon-container {% if has_unread_kairanban %}has-unread-kairanban{% endif %}">
                            <img src="{{ url_for('static', filename='icons/note.png') }}" alt="回覧板">
                        </div>
                        <span>回覧板</span>
                    </a>
                </li>
            </ul>
        </nav>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // ▼▼▼ [修正] Flashメッセージを閉じる機能 ▼▼▼
    const dismissFlashBtn = document.getElementById('dismiss-flash-btn');
    const flashContainer = document.getElementById('flash-message-container');

    if (dismissFlashBtn && flashContainer) {
        dismissFlashBtn.addEventListener('click', function() {
            // コンテナを非表示にする
            flashContainer.style.display = 'none';
        });
    }
    // ▲▲▲ 修正ここまで ▲▲▲


    // --- 1. ヘルパー関数と共通の要素を取得 ---
    const resizeTextarea = (textarea) => {
        if (!textarea) return;
        textarea.style.height = 'auto';
        const maxHeight = parseInt(window.getComputedStyle(textarea).maxHeight, 10);
        const scrollHeight = textarea.scrollHeight;
        if (maxHeight > 0 && scrollHeight > maxHeight) {
            textarea.style.height = maxHeight + 'px';
            textarea.style.overflowY = 'auto';
        } else {
            textarea.style.height = scrollHeight + 'px';
            textarea.style.overflowY = 'hidden';
        }
    };

    const headerDropdownContainer = document.querySelector('.dropdown-container');
    const toggleButton = document.getElementById('toggle-post-form-btn');
    const postFormContainer = document.getElementById('post-form-container');
    const imageInput = document.getElementById('image');
    
    const toggleCommentButton = document.getElementById('toggle-comment-form-btn');
    const commentFormContainer = document.getElementById('comment-form-container');
    const toggleTagButton = document.getElementById('toggle-tag-form-btn');
    const tagFormContainer = document.getElementById('tag-form-container');
    
    const recentTagsToggle = document.getElementById('recent-tags-toggle');
    const recentTagsList = document.getElementById('recent-tags-list');
    const tagsInputField = document.getElementById('tags-input-field'); 


    // --- 2. テキストエリア関連の要素を取得 ---
    const allEditableTextareas = document.querySelectorAll('.auto-resize-textarea');

    // --- 3. イベントリスナーの設定 ---

    // ヘッダーのドロップダウン処理
    if (headerDropdownContainer) {
        const headerDropdownContent = headerDropdownContainer.querySelector('.dropdown-content');
        if (headerDropdownContent) {
            headerDropdownContainer.querySelector('a').addEventListener('click', function(event) {
                event.preventDefault(); event.stopPropagation();
                const isHidden = headerDropdownContent.style.display === 'none' || headerDropdownContent.style.display === '';
                headerDropdownContent.style.display = isHidden ? 'block' : 'none';
            });
        }
    }

    // 「新しい投稿をする」ボタンの処理
    if (toggleButton && postFormContainer) {
        toggleButton.addEventListener('click', function() {
            postFormContainer.classList.toggle('hidden');
            if (postFormContainer.classList.contains('hidden')) {
                toggleButton.innerHTML = '新しい投稿をする <i class="fas fa-plus"></i>';
            } else {
                toggleButton.innerHTML = 'フォームを閉じる <i class="fas fa-minus"></i>';
            }
        });
    }

    if (toggleCommentButton && commentFormContainer) {
        toggleCommentButton.addEventListener('click', function() {
            commentFormContainer.classList.toggle('hidden');
            if (commentFormContainer.classList.contains('hidden')) {
                toggleCommentButton.innerHTML = 'コメントをする <i class="fas fa-plus"></i>';
            } else {
                toggleCommentButton.innerHTML = 'フォームを閉じる <i class="fas fa-minus"></i>';
            }
        });
    }

    
    
// --- テキストエリアの自動リサイズ処理 (全デバイス共通) ---
allEditableTextareas.forEach(textarea => {
    // ページ読み込み時の初回リサイズ (スクロールなし)
    setTimeout(() => resizeTextarea(textarea), 100);

    // 入力時のリサイズ (スクロールあり)
    textarea.addEventListener('input', () => {
        // 1. リサイズ前の高さを取得
        const oldHeight = textarea.offsetHeight;

        // 2. テキストエリアをリサイズ (resizeTextarea関数を呼ぶ)
        resizeTextarea(textarea); 

        // 3. リサイズ後の高さを取得
        const newHeight = textarea.offsetHeight;

        // 4. 高さがどれだけ増えたか計算
        const heightDifference = newHeight - oldHeight;

        // 5. 高さが変化した場合のみ、その分だけウィンドウをスクロール
	// (最大高さに達した時などは heightDifference = 0 になる)
	if (heightDifference !== 0) {
    		// 6. カーソルのY座標を追従させるため、即座にスクロール
    		window.scrollBy(0, heightDifference);
	}
    });
});

    // --- 4. テンプレート機能の処理 ---
    const allTemplateDropdowns = document.querySelectorAll('.template-dropdown');
    allTemplateDropdowns.forEach(dropdown => {
        const selectBtn = dropdown.querySelector('.template-select-btn');
        const dropdownContent = dropdown.querySelector('.template-dropdown-content');
        if(selectBtn && dropdownContent) {
            selectBtn.addEventListener('click', function(event) {
                event.stopPropagation();
                dropdownContent.classList.toggle('hidden');
            });
        }
    });


// --- UECreviewフォーム関連の関数 ---

    // 1. 科目ブロックを1つ生成してコンテナに追加する関数
    function addUecSubjectBlock(container, data = null) {
        const index = container.querySelectorAll('.uec-form-set').length;
        const formSet = document.createElement('div');
        formSet.className = 'uec-form-set';
        
        let gradesOptions = ['秀', '優', '良', '可', '不可', '（未評価）']
            .map(g => `<option value="${g}">${g}</option>`).join('');

        // HTML生成 (削除ボタン追加、テキストエリアのクラス修正)
        formSet.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; margin-bottom: 10px; padding-bottom: 5px;">
                <h3 class="subject-index-label" style="margin: 0;">科目 ${index + 1}</h3>
                <button type="button" class="delete-subject-btn" style="background: none; border: none; color: #dc3545; cursor: pointer; font-size: 0.9em;">
                    <i class="fas fa-trash-alt"></i> 削除
                </button>
            </div>
            <div>
                <label>科目名:</label>
                <input type="text" class="uec-subject" placeholder="例：〇〇論">
            </div>
            <div>
                <label>担当教員:</label>
                <input type="text" class="uec-teacher" placeholder="例：〇〇 先生">
            </div>
            <div>
                <label>成績:</label>
                <select class="uec-grade">
                    ${gradesOptions}
                </select>
            </div>
            <div>
                <label>本文 (レビュー):</label>
                <textarea class="uec-review-body auto-resize-textarea" placeholder="例：テストの難易度、課題について等" rows="3" style="resize: none;"></textarea>
            </div>
        `;

        // データを埋め込み
        if (data) {
            formSet.querySelector('.uec-subject').value = data.subject || '';
            formSet.querySelector('.uec-teacher').value = data.teacher || '';
            formSet.querySelector('.uec-grade').value = data.grade || '（未評価）';
            formSet.querySelector('.uec-review-body').value = data.body || '';
        }

        // テキストエリアの自動リサイズを適用
        const textarea = formSet.querySelector('.uec-review-body');
        if (textarea) {
            // 初期リサイズ
            setTimeout(() => resizeTextarea(textarea), 0);
            // 入力時リサイズイベント
            textarea.addEventListener('input', () => resizeTextarea(textarea));
        }

        // 削除ボタンのイベント
        const deleteBtn = formSet.querySelector('.delete-subject-btn');
        deleteBtn.addEventListener('click', function() {
            if (confirm('この科目を削除しますか？')) {
                formSet.remove();
                updateSubjectNumbers(container); // 番号を振り直す
            }
        });

        container.appendChild(formSet);
    }

    // 2. 科目番号 (科目 1, 科目 2...) を振り直す関数
    function updateSubjectNumbers(container) {
        const sets = container.querySelectorAll('.uec-form-set');
        sets.forEach((set, i) => {
            const label = set.querySelector('.subject-index-label');
            if (label) label.textContent = `科目 ${i + 1}`;
        });
    }

    // 3. メインのフォーム生成関数 (親コンテナを初期化してボタン類を配置)
    function createUecReviewForm(initialCount, container, titleInput, templateTitle, existing_data = []) {
        if (!container) return;

        // タイトルの設定 (新規かつデータなしの場合のみ)
        if (titleInput && templateTitle && existing_data.length === 0) {
            titleInput.value = templateTitle;
        }

        // コンテナをクリア
        container.innerHTML = '';

        // フィールドを格納するラッパーを作成
        const fieldsWrapper = document.createElement('div');
        fieldsWrapper.id = 'uec-fields-wrapper';
        container.appendChild(fieldsWrapper);

        // 既存データがある場合はその数だけ、ない場合は指定数だけ生成
        const count = existing_data.length > 0 ? existing_data.length : initialCount;
        
        for (let i = 0; i < count; i++) {
            const data = existing_data.length > 0 ? existing_data[i] : null;
            addUecSubjectBlock(fieldsWrapper, data);
        }

        // 「＋ 新規追加」ボタンを作成
        const addBtnContainer = document.createElement('div');
        addBtnContainer.style.textAlign = 'center';
        addBtnContainer.style.marginTop = '15px';
        addBtnContainer.style.marginBottom = '25px';
        addBtnContainer.innerHTML = `
            <button type="button" id="add-uec-subject-btn" style="background: none; border: 2px dashed #007bff; color: #007bff; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-weight: bold;">
                <i class="fas fa-plus"></i> 科目を追加
            </button>
        `;
        container.appendChild(addBtnContainer);

        // 追加ボタンのイベント
        const addBtn = addBtnContainer.querySelector('#add-uec-subject-btn');
        addBtn.addEventListener('click', function() {
            addUecSubjectBlock(fieldsWrapper);
            // スクロールなどの微調整があればここに
        });

        // 表示切り替え処理
        container.classList.remove('hidden');
        const originalContentField = container.closest('form').querySelector('#content-field-original');
        if (originalContentField) {
            originalContentField.classList.add('hidden');
            const originalTextarea = originalContentField.querySelector('.auto-resize-textarea');
            if (originalTextarea) originalTextarea.required = false;
        }
    }

    // 4. 本文を組み立てる関数 (バリデーションと自動補完を追加)
    function buildUecReviewContent(container) {
        let combinedContent = '';
        const formSets = container.querySelectorAll('.uec-form-set');

        // forループに変更（途中で return して処理を中断できるようにするため）
        for (let i = 0; i < formSets.length; i++) {
            const set = formSets[i];
            const subject = set.querySelector('.uec-subject').value.trim();
            const teacher = set.querySelector('.uec-teacher').value.trim();
            const grade = set.querySelector('.uec-grade').value;
            const body = set.querySelector('.uec-review-body').value.trim();

            // --- ② [修正] 本文が未入力なら送信ブロック ---
            if (!body) {
                alert(`科目 ${i + 1} (${subject || '名称未設定'}) のレビュー本文が入力されていません。\n投稿するには本文の入力が必須です。`);
                return null; // nullを返してエラーを示す
            }

            // --- ① [修正] 教員名が空なら「不明」をセット ---
            const finalTeacher = teacher || '不明';
            
            // 科目名も空ならプレースホルダー的な文言を入れる（既存維持）
            const finalSubject = subject || '科目名なし';

            let reviewString = `<span class="text-large">**${finalSubject}**</span> `;
            reviewString += `成績:<span class="text-red text-large">**${grade}**</span> `;
            reviewString += `担当教員:${finalTeacher}\n`;
            reviewString += `${body}`;

            combinedContent += reviewString;

            if (i < formSets.length - 1) {
                combinedContent += '\n\n---\n\n'; 
            }
        }

        return combinedContent;
    }

    // テンプレート選択時の処理
    if (typeof TEMPLATES_DATA !== 'undefined' && TEMPLATES_DATA.length > 0) {
        document.querySelectorAll('.template-item').forEach(item => {
            item.addEventListener('click', function(event) {
                event.preventDefault();
                const templateIndex = parseInt(item.dataset.index, 10);
                const template = TEMPLATES_DATA[templateIndex];
                if (!template) return;

                const parentForm = this.closest('form');
                if (!parentForm) return;

                const titleInput = parentForm.querySelector('input[name="title"]');
                const originalContentTextarea = parentForm.querySelector('.auto-resize-textarea'); 
                const uecReviewContainer = parentForm.querySelector('#uecreview-form-container'); 
                const originalContentField = parentForm.querySelector('#content-field-original'); 
                
                let contentTextarea = originalContentTextarea;

                if (template.name === 'UECreview') {
                    const countStr = prompt('最初に作成する科目数は？', '1');
                    if (countStr) {
                        const halfWidthStr = countStr.replace(/[０-９]/g, s => String.fromCharCode(s.charCodeAt(0) - 0xFEE0));
                        const count = parseInt(halfWidthStr, 10);
                        if (!isNaN(count) && count > 0 && count <= 20) {
                            createUecReviewForm(count, uecReviewContainer, titleInput, template.title);
                        } else { alert('有効な数字(1〜20)を入力してください。'); }
                    }
                } else {
                    // 通常テンプレート
                    if (uecReviewContainer) uecReviewContainer.classList.add('hidden');
                    if (uecReviewContainer) uecReviewContainer.innerHTML = '';
                    
                    if (originalContentField) {
                        originalContentField.classList.remove('hidden');
                        const originalTextarea = originalContentField.querySelector('.auto-resize-textarea');
                        if (originalTextarea) originalTextarea.required = true;
                    } 

                    if (titleInput) titleInput.value = template.title;
                    if (contentTextarea) {
                        contentTextarea.value = template.body;
                        if (originalContentTextarea) resizeTextarea(originalContentTextarea);
                    }
                }

                // ドロップダウンを閉じる
                const parentDropdownContent = item.closest('.template-dropdown-content');
                if (parentDropdownContent) { parentDropdownContent.classList.add('hidden'); }
            });
        });
    }
    // --- 5. その他の機能 ---
    // 画像アップロード時のファイル名表示処理
    if (imageInput) {
        const filenameDisplay = document.getElementById('image-filename-display');
        const editFilenameDisplay = document.getElementById('edit-image-filename-display');
        imageInput.addEventListener('change', function() {
            if (file && file.size > 500 * 1024) {
                alert('画像サイズが大きすぎます（上限: 500KB）。\nサイズを小さくするか、別の画像を選択してください。');
                this.value = ''; // 入力をリセット
                if (filenameDisplay) filenameDisplay.textContent = '';
                return;
            }
            const file = this.files[0];
            const filename = file ? file.name : '';
            if (filenameDisplay) { filenameDisplay.textContent = filename; }
            if (editFilenameDisplay) { 
                const currentImageText = document.querySelector('#edit-image-filename-display').getAttribute('data-current-image') || '画像がありません';
                editFilenameDisplay.textContent = file ? `選択中: ${filename}` : currentImageText;
             }
        });
    }

    // ブックマークボタンの処理
    document.querySelectorAll('.bookmark-toggle-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const form = this.closest('.bookmark-form');
            const postId = form.dataset.postId;
            const url = `{{ url_for('bookmark_post', post_id=0) }}`.slice(0, -1) + postId;
            fetch(url, { method: 'POST', headers: { 'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/json' } })
            .then(response => response.json())
            .then(data => {
                const iconSpan = document.getElementById(`bookmark-icon-${postId}`);
                if (iconSpan) {
                    if (data.is_bookmarked) {
                        iconSpan.innerHTML = '<img src="{{ url_for("static", filename="icons/bookmarked.png") }}" alt="ブックマーク済み" style="width: 20px; height: 20px;">';
                    } else {
                        iconSpan.innerHTML = '<img src="{{ url_for("static", filename="icons/bookmark.png") }}" alt="ブックマーク" style="width: 20px; height: 20px;">';
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // コメント削除処理
document.querySelectorAll('.delete-comment-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const commentId = this.dataset.commentId;
            // ▼▼▼ 正しくはバッククォート (`) ▼▼▼
            const url = `/comment/${commentId}/delete`;
            if (confirm('本当にこのコメントを削除しますか？')) {
                fetch(url, { method: 'POST', headers: {'X-Requested-With': 'XMLHttpRequest', 'Content-Type': 'application/json'} })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const commentElement = document.getElementById(`comment-${commentId}`);
                        if (commentElement) {
                            commentElement.style.opacity = '0';
                            setTimeout(() => commentElement.remove(), 300);
                        }
                        const commentCountHeader = document.getElementById('comment-count-header');
                        if (commentCountHeader) { commentCountHeader.innerText = `コメント (${data.remaining_comments})`; }
                        const titleCommentCount = document.getElementById('title-comment-count');
                        if (titleCommentCount) { titleCommentCount.innerText = `コメント数(${data.remaining_comments})`; }
                    } else { alert('コメントの削除に失敗しました。'); }
                })
                .catch(error => console.error('Error:', error));
            }
        });
    }); 
   
    


    // --- タグフォームのトグル処理 ---
    if (toggleTagButton && tagFormContainer) {
        toggleTagButton.addEventListener('click', function(event) {
            event.preventDefault(); // aタグのデフォルト動作をキャンセル
            tagFormContainer.classList.toggle('hidden');
            
            // アイコンの + / - をトグルする (あれば)
            const icon = toggleTagButton.querySelector('i'); // (iタグは <i class="fas fa-plus"></i> のこと)
            if (icon) {
                if (tagFormContainer.classList.contains('hidden')) {
                    icon.classList.remove('fa-minus');
                    icon.classList.add('fa-plus');
                } else {
                    icon.classList.remove('fa-plus');
                    icon.classList.add('fa-minus');
                }
            }
        });
    }

    // ▼▼▼ 最近のタグ ドロップダウン機能 ▼▼▼
    if (recentTagsToggle && recentTagsList && tagsInputField) {
        
        // 1. アイコンクリックでドロップダウンを開閉
        recentTagsToggle.addEventListener('click', function(event) {
            event.preventDefault();
            event.stopPropagation(); // ドキュメント全体のクリックに伝播しないように

            // リストが非表示の時だけ、中身をフェッチして表示
            if (recentTagsList.classList.contains('hidden')) {
                fetch('{{ url_for("get_recent_tags") }}')
                    .then(response => response.json())
                    .then(tags => {
                        recentTagsList.innerHTML = ''; // 中身をクリア
                        if (tags.length > 0) {
                            tags.forEach(tagName => {
                                const tagItem = document.createElement('a');
                                tagItem.href = '#';
                                tagItem.className = 'recent-tag-item';
                                tagItem.textContent = tagName;
                                
                                // 2. ドロップダウン内のタグをクリックした時の処理
                                tagItem.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    
                                    // 現在の入力値を取得し、Setで重複を管理
                                    const currentTags = new Set(
                                        tagsInputField.value
                                            .split(',')
                                            .map(t => t.trim())
                                            .filter(Boolean) // 空の文字列を除去
                                    );
                                    
                                    // 新しいタグを追加
                                    currentTags.add(tagName);
                                    
                                    // 入力欄に反映
                                    tagsInputField.value = Array.from(currentTags).join(', ');
                                    
                                    // リストを閉じる
                                    recentTagsList.classList.add('hidden');
                                });
                                recentTagsList.appendChild(tagItem);
                            });
                        } else {
                            recentTagsList.innerHTML = '<span style="padding: 8px 12px; display: block; font-size: 0.9em; color: #6c757d;">最近使用したタグはありません</span>';
                        }
                        recentTagsList.classList.remove('hidden');
                    });
            } else {
                // すでに表示されている場合は、閉じるだけ
                recentTagsList.classList.add('hidden');
            }
        });
    }



//   6. フォーム送信時の処理 ---
 
    // ページ内のすべての投稿/編集フォームを取得
    const postForms = document.querySelectorAll('form[method="POST"][enctype="multipart/form-data"]');

    postForms.forEach(form => {
        form.addEventListener('submit', function(event) {
            const uecReviewContainer = form.querySelector('#uecreview-form-container');
            const originalContentTextarea = form.querySelector('.auto-resize-textarea'); // 元の本文

            // UECreviewコンテナが表示されている（アクティブである）場合
            if (uecReviewContainer && !uecReviewContainer.classList.contains('hidden') && originalContentTextarea) {

                // 1. UECreviewフォームから本文を組み立てる
                const combinedContent = buildUecReviewContent(uecReviewContainer);

                // --- [修正] バリデーションエラー時は送信を止める ---
                if (combinedContent === null) {
                    event.preventDefault(); // 送信キャンセル
                    event.stopPropagation();
                    return; // 処理終了
                }

                // 2. 元の本文テキストエリアに値を設定する
                originalContentTextarea.value = combinedContent;

                // 3. このままデフォルトの送信動作が進む
            }
        });
    });
// --- 7. 編集ページ用のUECreviewデータ読み込み ---

    // 編集フォーム（indexの投稿フォームではない）が存在する場合のみ実行
    const editForm = document.querySelector('form[method="POST"][enctype="multipart/form-data"]');
    // const postFormContainer = ... (二重宣言になるため削除)

    if (editForm && !postFormContainer) { // (postFormContainerはスクリプト上部 で宣言済み)
        // サーバーから渡されたJSONデータがあるか確認
        {% if uec_review_data_json is defined and uec_review_data_json %}
            try {
                // テンプレートに埋め込まれたJSONをパース
                const reviewData = {{ uec_review_data_json | safe }};

                if (reviewData && reviewData.length > 0) {
                    // フォーム生成に必要な要素を取得
                    const titleInput = editForm.querySelector('input[name="title"]');
                    const uecReviewContainer = editForm.querySelector('#uecreview-form-container'); 

                    // UECreviewフォームをデータ付きで生成 (5引数の関数を呼ぶ)
                    createUecReviewForm(reviewData.length, uecReviewContainer, titleInput, null, reviewData);
                }
            } catch (e) {
                console.error("UECreview データのパースに失敗しました:", e);
            }
        {% endif %}
    }
    // --- ドロップダウンを閉じるグローバルなクリック処理 ---
    document.addEventListener('click', function(event) {
        // 1. ヘッダーのユーザーアイコン
        if (headerDropdownContainer && !headerDropdownContainer.contains(event.target)) {
            const content = headerDropdownContainer.querySelector('.dropdown-content');
            if (content) content.style.display = 'none';
        }
        
        // 2. 投稿フォームの「テンプレートを選択」
        if (!event.target.closest('.template-dropdown')) {
            document.querySelectorAll('.template-dropdown-content').forEach(content => {
                content.classList.add('hidden');
            });
        }

        // 3. 「最近のタグ」ドロップダウン
        if (!event.target.closest('#recent-tags-toggle') && !event.target.closest('.recent-tags-dropdown')) {
            
            // ページ上にある「全ての」最近のタグリストを閉じる
            document.querySelectorAll('.recent-tags-dropdown').forEach(list => {
                list.classList.add('hidden');
            });
        }
    });

    document.querySelectorAll('.kairanban-check-toggle').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const kairanbanId = this.dataset.kairanbanId;
            const url = `/kairanban/check/${kairanbanId}`;
            const itemElement = document.getElementById(`kairanban-${kairanbanId}`);

            fetch(url, {
                method: 'POST',
                headers: { 
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json' 
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    
                    // 1. まずクリックされたアイテムのスタイルを更新 (既存の処理)
                    if (data.is_checked) {
                        if (itemElement) itemElement.classList.add('checked');
                    } else {
                        if (itemElement) itemElement.classList.remove('checked');
                    }

                    // 閲覧数カウントのspanを取得してテキストを更新
                    const countSpan = document.getElementById(`check-count-${kairanbanId}`);
                    if (countSpan) {
                        countSpan.textContent = `👀 ${data.new_count}`;
                    }
                    // 2. 【リアルタイム更新】
                    //    ページ上の「チェックされていない回覧板」の数を数える
                    const unreadCount = document.querySelectorAll('.kairanban-item:not(.checked) .kairanban-check-container').length;

                    // 3. ページ上の「すべての」回覧板アイコンコンテナを取得
                    const iconContainers = document.querySelectorAll('.kairanban-icon-container');
                    
                    if (unreadCount === 0) {
                        // 4a. もし未読が 0 件になったら、すべてのアイコンから赤丸クラスを削除
                        iconContainers.forEach(container => {
                            container.classList.remove('has-unread-kairanban');
                        });
                    } else {
                        // 4b. もし未読が 1 件以上ある（またはチェックを外した）場合、すべてのアイコンに赤丸クラスを追加
                         iconContainers.forEach(container => {
                            container.classList.add('has-unread-kairanban');
                        });
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // ▼▼▼ [修正] 「8. プロフィール編集フォーム」 Safari対応版 ▼▼▼
    const gradeSelect = document.getElementById('form-select-grade');
    
    if (gradeSelect) {
        const categoryDiv = document.getElementById('form-field-category');
        const classDiv = document.getElementById('form-field-class');
        const programDiv = document.getElementById('form-field-program');
        const majorDiv = document.getElementById('form-field-major');
        
        const categorySelect = document.getElementById('form-select-category');
        const classSelect = document.getElementById('form-select-class');
        const programSelect = document.getElementById('form-select-program');
        const majorSelect = document.getElementById('form-select-major');

        // --- Safari対策: 選択肢を物理的に削除・再構築する関数 ---
        const filterSelectOptions = (selectElement, predicate) => {
            // 初回実行時に、すべての選択肢をメモリにバックアップする
            if (!selectElement._originalOptions) {
                selectElement._originalOptions = Array.from(selectElement.options).map(opt => ({
                    value: opt.value,
                    text: opt.text
                }));
            }

            const currentVal = selectElement.value;
            selectElement.innerHTML = ''; // 一旦空にする

            let isCurrentValValid = false;

            selectElement._originalOptions.forEach(optData => {
                // 空文字（"--- 選択 ---"）は常に表示、それ以外は条件判定
                if (optData.value === '' || predicate(optData.value)) {
                    const option = document.createElement('option');
                    option.value = optData.value;
                    option.textContent = optData.text;
                    selectElement.appendChild(option);

                    if (optData.value === currentVal) {
                        isCurrentValValid = true;
                    }
                }
            });

            // もともと選んでいた値が有効なら維持、無効になったらリセット
            if (isCurrentValValid) {
                selectElement.value = currentVal;
            } else {
                selectElement.value = '';
            }
        };

        // --- 判定ロジック関数群 ---
        const getClassGroup = (value) => {
            if (['1クラス', '2クラス', '3クラス', '4クラス', '5クラス', '6クラス', '7クラス', '8クラス', '9クラス', '10クラス', '11クラス', '12クラス'].includes(value)) return '1_year';
            if (['Aクラス', 'Bクラス', 'Cクラス'].includes(value)) return '2_year_I';
            if (['I1', 'I2', 'I3', 'I4', 'I5', 'I6', 'Mエリア'].includes(value)) return '2_year_II';
            if (['III類1クラス', 'III類2クラス', 'III類3クラス', 'III類4クラス'].includes(value)) return '2_year_III';
            return 'other';
        };

        const getProgramGroup = (value) => {
            const programs_I = ['メディア情報学プログラム', '経営・社会情報学プログラム', '情報数理工学プログラム', 'コンピュータサイエンスプログラム', 'デザイン思考・データサイエンスプログラム'];
            const programs_II = ['セキュリティ情報学プログラム', '情報通信工学プログラム', '電子情報学プログラム', '計測・制御システムプログラム', '先端ロボティクスプログラム'];
            const programs_III = ['機械システムプログラム', '電子工学プログラム', '光工学プログラム', '物理工学プログラム', '化学生命工学プログラム'];
            if (programs_I.includes(value)) return 'I類';
            if (programs_II.includes(value)) return 'II類';
            if (programs_III.includes(value)) return 'III類';
            return 'other';
        };

        const getMajorByProgram = (programValue) => {
            const major_JohoGaku = ['メディア情報学プログラム', '経営・社会情報学プログラム', 'デザイン思考・データサイエンスプログラム', 'セキュリティ情報学プログラム'];
            if (major_JohoGaku.includes(programValue)) return '情報学専攻';

            const major_JohoNetwork = ['情報通信工学プログラム', '電子情報学プログラム', '情報数理工学プログラム', 'コンピュータサイエンスプログラム'];
            if (major_JohoNetwork.includes(programValue)) return '情報・ネットワーク工学専攻';

            const major_KikaiChino = ['機械システムプログラム', '計測・制御システムプログラム', '先端ロボティクスプログラム'];
            if (major_KikaiChino.includes(programValue)) return '機械知能システム学専攻';

            const major_KibanRiko = ['光工学プログラム', '物理工学プログラム', '化学生命工学プログラム', '電子工学プログラム'];
            if (major_KibanRiko.includes(programValue)) return '基盤理工学専攻';
            
            return ''; 
        };

        const getCategoryForFirstYear = (classValue) => {
            if (!classValue) return '';
            const classNum = parseInt(classValue.replace('クラス', ''), 10);
            if (classNum >= 1 && classNum <= 4) return 'I類';
            if (classNum >= 5 && classNum <= 8) return 'II類';
            if (classNum >= 9 && classNum <= 12) return 'III類';
            return '';
        };

        // --- メインの表示切替ロジック ---
        const updateFormVisibility = () => {
            const gradeVal = gradeSelect.value;
            const categoryVal = categorySelect.value;
            const classVal = classSelect.value;
            const programVal = programSelect.value;

            // 1. 全ての表示枠を一旦リセット
            categoryDiv.style.display = 'none';
            classDiv.style.display = 'none';
            programDiv.style.display = 'none';
            majorDiv.style.display = 'none';
            
            categorySelect.disabled = false;
            majorSelect.disabled = false;
            categorySelect.style.pointerEvents = 'auto';
            categorySelect.style.backgroundColor = '#fff';
            majorSelect.style.pointerEvents = 'auto';
            majorSelect.style.backgroundColor = '#fff';

            // 2. 「類」の選択肢をフィルタリング (大学院生ならK課程を消す)
            filterSelectOptions(categorySelect, (val) => {
                if (gradeVal === '大学院生') {
                    return val !== 'K課程'; // 大学院生ならK課程を除外
                }
                return true; // それ以外は全表示
            });

            // K課程の場合の特別処理
            if (categoryVal === 'K課程') {
                categoryDiv.style.display = 'block';
                return; 
            }

            if (gradeVal === '1年') {
                categoryDiv.style.display = 'block'; 
                classDiv.style.display = 'block';
                
                // 1年生のクラス選択肢を更新 (選ばれた類に合わせて絞る)
                filterSelectOptions(classSelect, (val) => {
                    const group = getClassGroup(val);
                    if (group !== '1_year') return false; // 1年以外のクラスは消す

                    if (categoryVal === 'I類') return parseInt(val) >= 1 && parseInt(val) <= 4;
                    if (categoryVal === 'II類') return parseInt(val) >= 5 && parseInt(val) <= 8;
                    if (categoryVal === 'III類') return parseInt(val) >= 9 && parseInt(val) <= 12;
                    return true; // 類が未選択なら全部出す
                });

                // クラスから類を自動判定
                const autoCategory = getCategoryForFirstYear(classVal);
                if (autoCategory) {
                    categorySelect.value = autoCategory;
                    categorySelect.style.pointerEvents = 'none';
                    categorySelect.style.backgroundColor = '#e9ecef';
                }

            }
            else if (gradeVal === '2年') {
                categoryDiv.style.display = 'block';
                programDiv.style.display = 'block';
                
                if (categoryVal === 'I類' || categoryVal === 'II類' || categoryVal === 'III類') {
                    classDiv.style.display = 'block';
                    
                    // 2年生クラスの絞り込み
                    filterSelectOptions(classSelect, (val) => {
                        if (categoryVal === 'I類') return getClassGroup(val) === '2_year_I';
                        if (categoryVal === 'II類') return getClassGroup(val) === '2_year_II';
                        if (categoryVal === 'III類') return getClassGroup(val) === '2_year_III';
                        return false;
                    });

                    // プログラムの絞り込み
                    filterSelectOptions(programSelect, (val) => {
                        if (val === '未決定') return true;
                        return getProgramGroup(val) === categoryVal;
                    });
                } else {
                    // 類未選択時: プログラムは全部表示(未決定含む)、クラスは隠す
                    filterSelectOptions(programSelect, () => true);
                }
            }
            else if (gradeVal === '3年' || gradeVal === '4年') {
                categoryDiv.style.display = 'block';
                programDiv.style.display = 'block';
                
                filterSelectOptions(programSelect, (val) => {
                    if (val === '未決定') return true;
                    if (!categoryVal) return true;
                    return getProgramGroup(val) === categoryVal;
                });
            }
            else if (gradeVal === '大学院生') {
                categoryDiv.style.display = 'block';
                programDiv.style.display = 'block';
                majorDiv.style.display = 'block';
                
                // プログラムの絞り込み
                filterSelectOptions(programSelect, (val) => {
                    if (val === '未決定') return true;
                    if (!categoryVal) return true;
                    return getProgramGroup(val) === categoryVal;
                });

                // 専攻の絞り込み (プログラムに合わせて)
                const targetMajor = getMajorByProgram(programVal);
                
                filterSelectOptions(majorSelect, (val) => {
                    if (!programVal || programVal === '未決定') return true; // プログラム未定なら全専攻表示
                    return val === targetMajor;
                });

                // 専攻の自動設定とロック
                if (targetMajor) {
                    majorSelect.value = targetMajor;
                    majorSelect.style.pointerEvents = 'none';
                    majorSelect.style.backgroundColor = '#e9ecef';
                }
            }
        };

        // --- イベントリスナー ---
        gradeSelect.addEventListener('change', () => {
            // 学年が変わったらリセット
            categorySelect.value = '';
            classSelect.value = '';
            programSelect.value = '';
            majorSelect.value = '';
            updateFormVisibility();
        });
        
        categorySelect.addEventListener('change', () => {
            classSelect.value = '';
            programSelect.value = '';
            majorSelect.value = '';
            updateFormVisibility();
        });

        classSelect.addEventListener('change', () => {
            if (gradeSelect.value === '1年') {
                updateFormVisibility();
            }
        });

        programSelect.addEventListener('change', () => {
            majorSelect.value = '';
            if (gradeSelect.value === '大学院生') {
                updateFormVisibility();
            }
        });

        // 初期化
        updateFormVisibility();
    }
    // ▲▲▲ 「8. プロフィール編集フォーム」ここまで ▲▲▲
    const profileEditForm = document.getElementById('profile-edit-form');
    const usernameInput = document.getElementById('username-input');
    const iconInput = document.getElementById('icon-input-field');
    const filenameDisplay = document.getElementById('icon-filename-display');
    
    // アイコンファイル名表示
    if (iconInput && filenameDisplay) {
        iconInput.addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                filenameDisplay.textContent = file.name;
            } else {
                filenameDisplay.textContent = '';
            }
        });
    }
    
    // ユーザー名変更確認
    if (profileEditForm && usernameInput) {
        editForm.addEventListener('submit', function(event) {
            const newUsername = usernameInput.value.trim();
            const originalUsername = usernameInput.dataset.originalUsername;
            if (newUsername !== originalUsername) {
                const message = `ユーザー名が変更されています ( ${originalUsername} → ${newUsername} )。\n\n更新後は自動的にログアウトします。\nよろしいですか？`;
                if (!confirm(message)) {
                    event.preventDefault(); 
                }
            }
        });
    }
    
}); // <-- ★★★ DOMContentLoaded はここで閉じる ★★★

</script>
{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
        const collapseLongComments = () => {
        const comments = document.querySelectorAll('.comment-content');
        const LIMIT_HEIGHT = 160; // 折りたたむ基準の高さ (CSSのmax-heightより少し大きめに)

        comments.forEach(comment => {
            // すでにボタンがある場合は処理しない（二重防止）
            if (comment.nextElementSibling && comment.nextElementSibling.classList.contains('read-more-btn')) {
                return;
            }

            // 高さが基準を超えているかチェック
            if (comment.scrollHeight > LIMIT_HEIGHT) {
                // 1. クラスを追加して折りたたむ
                comment.classList.add('collapsed');

                // 2. 「全文を表示」ボタンを作成
                const btn = document.createElement('button');
                btn.innerText = '...全文を表示する ▽';
                btn.className = 'read-more-btn';

                // ▼▼▼ 3. ボタンクリック時の動作 ▼▼▼
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    if (comment.classList.contains('collapsed')) {
                        // 閉じていたら開く
                        comment.classList.remove('collapsed');
                        this.innerText = '閉じる △'; // ボタンの文字を変更
                    } else {
                        // 開いていたら閉じる
                        comment.classList.add('collapsed');
                        this.innerText = '...全文を表示する ▽'; // ボタンの文字を戻す
                    }
                });

                // 4. コメントの直後にボタンを挿入
                comment.parentNode.insertBefore(btn, comment.nextSibling);
            }
        });
    };

    // ページ読み込み時に実行
    collapseLongComments();
    
    // (画像読み込みなどで高さが変わる場合があるので、少し遅れてもう一度実行すると確実です)
    setTimeout(collapseLongComments, 500);

    // --- リンクカード生成機能 (修正版: 1つだけ表示 & エラーハンドリング強化) ---
    const contentAreas = document.querySelectorAll('.post-content, .comment-content');
    
    contentAreas.forEach(area => {
        const links = area.querySelectorAll('a');
        
        // 記事内のリンクを順番にチェック
        for (const link of links) {
            const url = link.href;

            // 1. 無効なリンクはスキップ
            if (!url.startsWith('http://') && !url.startsWith('https://')) continue;
            if (url.includes(window.location.hostname)) continue;
            if (url.match(/\.(jpeg|jpg|gif|png|webp|heic|heif)$/i)) continue;

            // 2. APIに問い合わせ
            fetch(`/api/ogp?url=${encodeURIComponent(url)}`)
                .then(response => {
                    if (!response.ok) {
                        // 400エラーや500エラーの場合もここでキャッチさせる
                        throw new Error(`Server returned ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) return;

                    // カード作成
                    const card = document.createElement('a');
                    card.href = data.url;
                    card.className = 'link-card';
                    card.target = '_blank';
                    card.rel = 'noopener noreferrer';
                    
                    let imageHtml = '';
                    if (data.image) {
                        imageHtml = `<div class="link-card-image" style="background-image: url('${data.image}')"></div>`;
                    }

                    card.innerHTML = `
                        ${imageHtml}
                        <div class="link-card-content">
                            <div class="link-card-title">${data.title}</div>
                            <div class="link-card-desc">${data.description}</div>
                            <div class="link-card-url">${new URL(data.url).hostname}</div>
                        </div>
                    `;

                    // カード置き場を作成して挿入
                    const contentWrapper = link.closest('.post-content') || link.closest('.comment-content');
                    if (contentWrapper) {
                        let cardContainer = contentWrapper.nextElementSibling;
                        if (!cardContainer || !cardContainer.classList.contains('link-card-container')) {
                            cardContainer = document.createElement('div');
                            cardContainer.className = 'link-card-container';
                            contentWrapper.parentNode.insertBefore(cardContainer, contentWrapper.nextSibling);
                        }
                        
                        if (cardContainer.children.length === 0) {
                            cardContainer.appendChild(card);
                        }
                    }
                })
                .catch(err => {
                    console.log('OGP fetch failed for:', url, err);
                });

            // 最初の1つを見つけたらループ終了
            break; 
        }
    });

    // ▼▼▼ 画像拡大（ライトボックス）機能 ▼▼▼
    
    // 1. モーダルのHTMLをbodyに追加
    const modalHtml = `
        <div id="image-modal">
            <span id="close-modal">&times;</span>
            <img class="modal-content-img" id="expanded-image">
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);

    const modal = document.getElementById('image-modal');
    const modalImg = document.getElementById('expanded-image');
    const closeSpan = document.getElementById('close-modal');

    // 2. 画像クリックでモーダルを表示 (Event Delegationを使用)
    document.addEventListener('click', function(e) {
        // .post-image クラスを持つ要素がクリックされたら実行
        if (e.target && e.target.classList.contains('post-image')) {
            e.preventDefault(); // リンク化されていた場合の遷移を防ぐ
            modal.style.display = "flex"; // Flexboxで中央寄せ
            modalImg.src = e.target.src; // クリックした画像のURLをセット
        }
    });

    // 3. 閉じる処理 (×ボタン)
    if (closeSpan) {
        closeSpan.onclick = function() {
            modal.style.display = "none";
        }
    }

    // 4. 閉じる処理 (画像の背景部分をクリック)
    if (modal) {
        modal.onclick = function(e) {
            if (e.target === modal) { // 画像そのものではなく、背景をクリックした場合
                modal.style.display = "none";
            }
        }
    }
    // ▲▲▲ 画像拡大機能 ここまで ▲▲▲
});

// ▼▼▼いいねボタンの機能 ▼▼▼
    document.querySelectorAll('.like-toggle-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation(); // 親要素への伝播を防ぐ
            
            // フォームからIDを取得
            const form = this.closest('.like-form');
            const postId = form.dataset.postId;
            const url = `/like/${postId}`;
            
            fetch(url, {
                method: 'POST',
                headers: { 
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json' 
                }
            })
            .then(response => response.json())
            .then(data => {
                // アイコンとカウントを更新
                const iconSpan = document.getElementById(`like-icon-${postId}`);
                const countSpan = document.getElementById(`like-count-${postId}`);
                
                if (data.is_liked) {
                    // いいね済みアイコン (赤色)
                    iconSpan.innerHTML = '<i class="fas fa-heart text-red"></i>';
                } else {
                    // 未いいねアイコン (グレー)
                    iconSpan.innerHTML = '<i class="far fa-heart"></i>';
                }
                
                // カウント更新
                if (countSpan) {
                    countSpan.textContent = data.count > 0 ? data.count : '';
                }
            })
            .catch(error => console.error('Error:', error));
        });
    });

    // ▼▼▼並び替えドロップダウンの機能 ▼▼▼
    const sortSelect = document.getElementById('sort-select');
    if (sortSelect) {
        sortSelect.addEventListener('change', function() {
            const selectedSort = this.value;
            const currentUrl = new URL(window.location.href);
            
            // URLパラメータを更新してリロード
            currentUrl.searchParams.set('sort_by', selectedSort);
            // ページネーションをリセットするためにページ番号は削除
            currentUrl.searchParams.delete('page');
            
            window.location.href = currentUrl.toString();
        });
    }

    // --- コメントメニューと返信フォームの制御 ---
    window.toggleCommentMenu = function(commentId) {
        const menu = document.getElementById(`comment-menu-${commentId}`);
        // 他のメニューを閉じる
        document.querySelectorAll('.comment-menu-dropdown').forEach(el => {
            if (el !== menu) el.classList.add('hidden');
        });
        menu.classList.toggle('hidden');
    };

    window.toggleReplyForm = function(commentId) {
        const form = document.getElementById(`reply-form-${commentId}`);
        form.classList.toggle('hidden');
        // メニューを閉じる
        document.getElementById(`comment-menu-${commentId}`).classList.add('hidden');
    };
    
    // 画面のどこかをクリックしたらメニューを閉じる
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.comment-menu-container')) {
            document.querySelectorAll('.comment-menu-dropdown').forEach(el => {
                el.classList.add('hidden');
            });
        }
    });

</script>
{% endblock %}

{% if current_user.is_authenticated %}
<script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
<script>
  window.OneSignalDeferred = window.OneSignalDeferred || [];
  OneSignalDeferred.push(function(OneSignal) {
    
    // 1. 初期化
    OneSignal.init({
      appId: "{{ config['ONESIGNAL_APP_ID'] or '66f089f7-9a47-4197-a0e4-3451c3d9e854' }}",
      serviceWorker: {
          path: "/OneSignalSDKWorker.js",
          workerName: "OneSignalSDKWorker.js",
          registrationOptions: { scope: '/' }
      },
      allowLocalhostAsSecureOrigin: true,

      
    }).then(function() {
        console.log("OneSignal Init Completed.");

        // 2. 【強制リセット処理】
        // 一度ログアウトを実行して、過去のIDとの縁を切る
        OneSignal.logout().then(function() {
            console.log("Force Logout executed.");
            
            // 3. その後、新しいIDとしてログインし直す
            setTimeout(function() {
                OneSignal.login("user_{{ current_user.id }}");
                console.log("Re-Login executed for User ID: user_{{ current_user.id }}");
            }, 500);
            
        }).catch(function(err) {
            // もしログアウト済みでエラーになっても、構わずログインする
            console.log("Logout skipped or failed, proceeding to login...");
            OneSignal.login("{{ current_user.id }}");
        });

    });
  });
</script>
{% endif %}
</body>
</html>