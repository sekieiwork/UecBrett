{% extends "base_layout.html" %}

{% block title %}投稿編集 - {{ post.title }}{% endblock %}

{% block content %}
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h1>投稿編集</h1>
    </div>

    <script>
        // 既にreviewタグがついているか、もしくはUECreviewデータがあるか
        const IS_REVIEW_POST = {{ 'true' if 'review' in post.tags|map(attribute='name')|list or uec_review_data_json else 'false' }};
        const CURRENT_USERNAME = "{{ current_user.username }}";
    </script>

    <form method="POST" enctype="multipart/form-data" class="post-form" style="padding-top: 4em;">
        {{ form.csrf_token }}

        <div style="position: absolute; top: 1.5em; right: 1.5em; display: flex; align-items: center; gap: 15px;">
            <a href="javascript:void(0)" id="toggle-tag-form-btn" title="タグを編集">
                <img src="{{ url_for('static', filename='icons/ei-tag.png') }}" alt="タグ" style="width: 24px; height: 24px; vertical-align: middle;">
            </a>
            
            {% if templates %}
            <div class="template-dropdown">
                <button type="button" class="template-select-btn" id="template-select-trigger">テンプレートを選択</button>
                <button type="button" class="template-remove-btn hidden" id="template-remove-trigger" style="background-color: #dc3545; color: white; padding: 8px 12px; font-size: 0.9em; border: none; border-radius: 4px; cursor: pointer;">テンプレートを解除</button>
                <div class="template-dropdown-content hidden">
                    {% for t in templates %}
                    <a href="#" class="template-item" data-index="{{ loop.index0 }}">{{ t.name }}</a>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <div class="form-field">
            <div id="uec-formal-name-notice" class="hidden" style="margin-bottom: 8px; background-color: #fff3cd; padding: 10px; border-radius: 4px; border: 1px solid #ffeeba;">
                <p class="text-red" style="font-size: 0.9em; margin: 0 0 5px 0; font-weight: bold;">
                    ※授業名は正式名称で記入してください。
                </p>
                <p style="font-size: 0.85em; margin: 0; color: #856404;">
                    ※教員への誹謗中傷、容姿や人格への言及は禁止です。<br>
                    授業の感想や評価に基づいた内容を心がけてください。
                </p>
            </div>
            {{ form.title.label }}<br>
            {{ form.title() }}

            <div id="uec-review-options" class="hidden" style="margin-top: 5px; gap: 10px; align-items: center; background-color: #f1f8ff; padding: 5px 10px; border-radius: 4px; flex-wrap: wrap;">
                <select id="uec-year-select" style="padding: 4px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9em;">
                    </select>
                <select id="uec-grade-select" style="padding: 4px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9em;">
                    <option value="">(学年なし)</option>
                    <option value="1年">1年</option>
                    <option value="2年">2年</option>
                    <option value="3年">3年</option>
                    <option value="4年">4年</option>
                </select>
                <select id="uec-term-select" style="padding: 4px; border-radius: 4px; border: 1px solid #ccc; font-size: 0.9em;">
                    <option value="">(学期なし)</option>
                    <option value="前期">前期</option>
                    <option value="後期">後期</option>
                </select>
                <span style="font-size: 0.8em; color: #666;">変更するとタイトルに反映されます</span>
            </div>
        </div>

        <div id="fixed-tag-area" class="hidden" style="margin-bottom: 10px;">
            <span class="tag-box" style="background-color: #e9ecef; color: #495057; border-color: #ced4da; cursor: not-allowed; user-select: none;">
                <i class="fas fa-tag"></i> review (自動付与)
            </span>
        </div>

        <div id="tag-form-container" class="form-field hidden" style="position: relative;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5em;">
                <label for="tags-input-field">タグ (カンマ区切りで入力)</label>
                <a href="javascript:void(0)" id="recent-tags-toggle" title="最近使用したタグ">
                    <img src="{{ url_for('static', filename='icons/underdir.png') }}" alt="最近のタグ" style="width: 20px; height: 20px;">
                </a>
            </div>
            <div id="recent-tags-list" class="recent-tags-dropdown hidden">
                </div>
            {{ form.tags(id="tags-input-field", placeholder="例: nクラス, review, B2") }}
        </div>

        <div class="form-field" id="content-field-original"> 
            {{ form.content.label }}<br>
            {{ form.content(cols=40, rows=5, class="auto-resize-textarea") }}
        </div>

        <div id="uecreview-form-container" class="hidden">
        </div>
        
        <div class="form-field" style="margin-top: 1em;">
            <label for="image">画像を変更</label><br>
            <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                <label for="image" style="cursor: pointer;">
                    <img src="{{ url_for('static', filename='icons/image_upload.png') }}" alt="画像アップロード" style="width: 24px; height: 24px; vertical-align: middle;">
                </label>
                {{ form.image(style="display: none;", accept="image/jpeg, image/png, image/gif") }}
                <span id="edit-image-filename-display" style="font-size: 0.8em; color: #6c757d;">
                    {% if post.image_url %}
                        現在設定中の画像: {{ post.image_url.split('/')[-1] }}
                    {% else %}
                        画像がありません
                    {% endif %}
                </span>
            </div>
            {% if post.image_url %}
                <div style="margin-top: 10px;">
                    <p style="font-size: 0.8em; margin-bottom: 5px;">現在の画像:</p>
                    <img src="{{ post.image_url }}" alt="現在の画像" class="post-image" style="max-width: 200px;">
                </div>
            {% endif %}
        </div>
        
        <div style="margin-top: 1.5em; display: flex; align-items: center; justify-content: space-between;">
            {{ form.submit(value='更新') }}
            <a href="{{ url_for('post_detail', post_id=post.id) }}">更新せずに戻る</a>
        </div>
    </form>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- 1. 既存のエンターキー制御 ---
        const titleInput = document.querySelector('input[name="title"]'); 
        const contentTextarea = document.querySelector('textarea[name="content"]');

        if (titleInput && contentTextarea) {
            titleInput.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    contentTextarea.focus();
                }
            });
        }

        // --- 2. UECreview シラバス連携ロジック ---
        
        // ヘルパー: datalistにoptionを追加する
        function fillDatalist(datalist, items) {
            if (!datalist) return;
            const uniqueItems = Array.from(new Set(items));
            datalist.innerHTML = uniqueItems.map(val => `<option value="${val}">`).join('');
        }

        // ヘルパー: 1つのフォームセットに対してイベントとデータを適用する
        function setupFormSet(set, syllabusData) {
            const subjectInput = set.querySelector('.uec-subject');
            const teacherInput = set.querySelector('.uec-teacher');
            if (!subjectInput || !teacherInput) return;

            // IDからdatalistを取得
            const subjListId = subjectInput.getAttribute('list');
            const teacherListId = teacherInput.getAttribute('list');
            const subjDatalist = document.getElementById(subjListId);
            const teacherDatalist = document.getElementById(teacherListId);

            // --- 修正: IME対応の入力イベントハンドラ ---
            const handleSubjectInput = function(event) {
                // ▼▼▼ 追加: IME変換中は処理を中断して、文字重複バグを防ぐ ▼▼▼
                if (event.type === 'input' && event.isComposing) {
                    return;
                }
                // ▲▲▲ 追加ここまで ▲▲▲

                const val = subjectInput.value; 
                
                if (!val) {
                    subjDatalist.innerHTML = ''; 
                    return;
                }

                // シラバスデータから部分一致で検索し、最大50件に絞る
                const MAX_CANDIDATES = 50;
                const filteredSubjects = [];
                let count = 0;

                for (const item of syllabusData) {
                    if (item.subject.indexOf(val) !== -1) {
                        filteredSubjects.push(item.subject);
                        count++;
                        if (count >= MAX_CANDIDATES) break;
                    }
                }
                
                fillDatalist(subjDatalist, filteredSubjects);
            };

            // 入力イベント（英数字など直接入力用）
            subjectInput.addEventListener('input', handleSubjectInput);
            
            // ▼▼▼ 追加: 変換確定イベント（日本語入力用） ▼▼▼
            subjectInput.addEventListener('compositionend', handleSubjectInput);
            
            // フォーカス時
            subjectInput.addEventListener('focus', handleSubjectInput);


            // --- 教員リスト更新ロジック ---
            const updateTeacherList = () => {
                if (!teacherDatalist || !syllabusData) return;
                const currentSubj = subjectInput.value;
                // 完全一致で検索
                const match = syllabusData.find(d => d.subject === currentSubj);
                
                if (match && match.teachers) {
                    fillDatalist(teacherDatalist, match.teachers);
                    // 教員が1人なら自動入力
                    if (match.teachers.length === 1) {
                        teacherInput.value = match.teachers[0];
                    }
                } else {
                    teacherDatalist.innerHTML = ''; 
                }
            };

            // 科目が確定(変更)されたら教員リストを更新
            subjectInput.addEventListener('change', function() {
                teacherInput.value = ''; 
                updateTeacherList();
            });
            
            // 初期状態でも、もし科目が入っていれば教員リストを作っておく
            if (subjectInput.value) {
                updateTeacherList();
            }
        }

        // メイン: 全フォームに適用する関数
        function applySyllabusDataToAllForms(data) {
            if (!data) return;
            window.cachedSyllabusData = data; 
            
            const uecContainer = document.getElementById('uecreview-form-container');
            if (!uecContainer) return;

            const formSets = uecContainer.querySelectorAll('.uec-form-set');
            formSets.forEach(set => setupFormSet(set, data));
        }

        // --- 3. 実行トリガー ---

        // (A) 初期ロード時
        if (titleInput && typeof IS_REVIEW_POST !== 'undefined' && IS_REVIEW_POST) {
            const yearMatch = titleInput.value.match(/(\d{4})年度/);
            const year = yearMatch ? yearMatch[0] : null;
            
            if (year) {
                fetch(`/api/syllabus?year=${encodeURIComponent(year)}`)
                    .then(r => r.json())
                    .then(data => {
                        applySyllabusDataToAllForms(data);
                    })
                    .catch(err => console.error("Syllabus API Error:", err));
            }
        }

        // (B) フォーム追加監視
        const uecContainer = document.getElementById('uecreview-form-container');
        if (uecContainer) {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.addedNodes.length > 0 && window.cachedSyllabusData) {
                        mutation.addedNodes.forEach(node => {
                            if (node.classList && node.classList.contains('uec-form-set')) {
                                setupFormSet(node, window.cachedSyllabusData);
                            }
                        });
                    }
                });
            });
            observer.observe(uecContainer, { childList: true });
        }
    });
</script>
{% endblock %}