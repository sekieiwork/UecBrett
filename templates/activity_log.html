{% extends "base_layout.html" %}

{% block title %}ToDoリスト{% endblock %}

{% block content %}
<style>
    body { overflow: hidden; }
    
    .activity-container {
        height: calc(100vh - 80px); 
        display: flex;
        flex-direction: column;
        padding-bottom: 10px;
        box-sizing: border-box;
    }

    /* --- メインエリア: フォーム & リスト --- */
    .main-section {
        flex: 1; /* 高さいっぱいに広げる */
        background: #fff;
        border-radius: 15px;
        border: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    }

    /* ヘッダー */
    .page-header {
        margin-bottom: 15px;
        display: flex;
        justify-content: space-between;
        align-items: baseline;
    }
    .page-header h2 { margin: 0; font-size: 1.5em; }
    .page-header span { color: #666; font-size: 0.9em; }

    /* フォーム周り */
    .form-row { 
        display: flex; 
        gap: 10px; 
        margin-bottom: 15px; 
        align-items: center;
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
    }
    
    .log-list { 
        flex: 1;
        overflow-y: auto; /* リスト部分だけスクロール */
        padding-right: 5px;
    }
    
    .todo-item { 
        display: flex; 
        align-items: center; 
        padding: 12px 0; 
        border-bottom: 1px solid #f9f9f9; 
        transition: background 0.2s;
    }
    .todo-item:hover { background-color: #fafafa; }
    
    .todo-item.completed span { 
        text-decoration: line-through; 
        color: #aaa; 
    }
    
    /* ToDo日付表示 */
    .todo-date-badge {
        font-size: 0.75em;
        color: #fff;
        background-color: #6c757d;
        padding: 2px 8px;
        border-radius: 12px;
        margin-left: 8px;
        white-space: nowrap;
    }
    
    .todo-delete {
        background: none; 
        border: none; 
        color: #dc3545; 
        cursor: pointer;
        font-size: 1.2em; 
        padding: 5px 15px; 
        margin-left: auto;
        opacity: 0.7;
    }
    .todo-delete:hover { opacity: 1; }

    input[type="text"] { 
        padding: 12px; 
        border: 1px solid #ced4da; 
        border-radius: 5px; 
        font-size: 1em;
    }

    /* カレンダーアイコン */
    .calendar-picker-wrapper {
        position: relative;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 5px;
        transition: background 0.2s;
    }
    .calendar-picker-wrapper:hover { background-color: #f0f0f0; }
    
    .calendar-picker-wrapper img {
        width: 28px;
        height: 28px;
        opacity: 0.6;
        transition: 0.2s;
    }
    .calendar-picker-wrapper.has-date img {
        opacity: 1;
        filter: drop-shadow(0 2px 3px rgba(40,167,69,0.3));
    }
    
    .calendar-input {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        opacity: 0;
        cursor: pointer;
    }
    
    .selected-date-label {
        font-size: 0.9em;
        color: #28a745;
        font-weight: bold;
        display: none;
        white-space: nowrap;
    }

    @media (max-width: 768px) { .activity-container { height: calc(100vh - 140px); } }
</style>

<div class="content-width-limiter activity-container">

    <div class="main-section">
        
        <div class="page-header">
            <h2><i class="fas fa-check-square text-green"></i> ToDoリスト</h2>
            <span id="current-date-display"></span>
        </div>

        <form id="todo-form" class="form-row">
            <input type="text" id="todo-task" placeholder="新しいタスクを追加..." required style="flex:1;">
            
            <div class="calendar-picker-wrapper" title="期限を設定">
                <img src="{{ url_for('static', filename='icons/calender.png') }}" alt="カレンダー">
                <input type="date" id="todo-date" class="calendar-input">
            </div>
            <span id="todo-date-display" class="selected-date-label"></span>

            <button type="submit" class="file-upload-btn" style="background:#28a745; color:white; font-weight:bold; padding: 10px 20px;">
                追加
            </button>
        </form>

        <div id="todo-list" class="log-list">
            Loading...
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        const dateStr = now.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
        document.getElementById('current-date-display').textContent = dateStr;

        // --- ToDo日付ピッカーの表示制御 ---
        const dateInput = document.getElementById('todo-date');
        const dateDisplay = document.getElementById('todo-date-display');
        const calendarWrapper = document.querySelector('.calendar-picker-wrapper');

        dateInput.addEventListener('change', function() {
            if (this.value) {
                const d = new Date(this.value);
                const md = (d.getMonth()+1) + '/' + d.getDate();
                dateDisplay.textContent = md;
                dateDisplay.style.display = 'inline';
                calendarWrapper.classList.add('has-date');
            } else {
                dateDisplay.style.display = 'none';
                calendarWrapper.classList.remove('has-date');
            }
        });

        // --- ToDoリスト機能 ---
        const todoForm = document.getElementById('todo-form');
        const todoList = document.getElementById('todo-list');

        function loadTodo() {
            fetch('/api/todo')
            .then(r => r.json())
            .then(data => {
                let html = '';
                data.forEach(t => {
                    const checked = t.is_completed ? 'checked' : '';
                    const cls = t.is_completed ? 'completed' : '';
                    
                    // 日付バッジ作成
                    let dateBadge = '';
                    if (t.date) {
                        dateBadge = `<span class="todo-date-badge">${t.date.slice(5)}まで</span>`; 
                    }
                    
                    html += `<div class="todo-item ${cls}">
                        <input type="checkbox" ${checked} onchange="toggleTodo(${t.id})" style="margin-right:15px; transform:scale(1.3); cursor:pointer;">
                        <span style="flex:1; font-size:1.05em;">${t.task} ${dateBadge}</span>
                        <button class="todo-delete" onclick="deleteTodo(${t.id})" title="削除"><i class="fas fa-times"></i></button>
                    </div>`;
                });
                
                todoList.innerHTML = html || '<p style="color:#ccc; text-align:center; margin-top:20px;">タスクはありません</p>';
            });
        }

        todoForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const task = document.getElementById('todo-task').value;
            const date = document.getElementById('todo-date').value;
            
            fetch('/api/todo', {
                method: 'POST', headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({action: 'add', task, date})
            }).then(() => {
                document.getElementById('todo-task').value = '';
                // 日付リセット
                document.getElementById('todo-date').value = '';
                document.getElementById('todo-date-display').style.display = 'none';
                calendarWrapper.classList.remove('has-date');
                loadTodo();
            });
        });

        window.toggleTodo = (id) => {
            fetch('/api/todo', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'toggle', id}) }).then(loadTodo);
        };

        window.deleteTodo = (id) => {
            fetch('/api/todo', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({action: 'delete', id}) }).then(loadTodo);
        };

        // 初期実行
        loadTodo();
    });
</script>
{% endblock %}